<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scout Pass | Command Center V34.0 (Final)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* DEFAULT (LIGHT) */
        :root { --primary: #3B82F6; --bg: #f5f6fa; --card: #ffffff; --text: #2d3436; --border: #dfe6e9; --input-bg: #f8f9fa; --gold: #FFD700; --silver: #C0C0C0; --bronze: #CD7F32; }
        /* DEEP BLACK THEME */
        [data-theme="dark"] { --bg: #000000; --card: #0F0F0F; --text: #ffffff; --border: #333333; --input-bg: #1a1a1a; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Outfit', sans-serif; transition: 0.3s; }
        [data-theme="dark"] .text-muted { color: #d1d5db !important; }
        [data-theme="dark"] .stat-card h6 { color: #ffffff !important; opacity: 1 !important; text-transform: uppercase; letter-spacing: 1px; }
        .sidebar { position: fixed; height: 100vh; width: 260px; background: var(--card); padding: 20px; z-index: 100; border-right: 1px solid var(--border); transition: 0.3s; }
        .main-content { margin-left: 260px; padding: 30px; min-height: 100vh; display: flex; flex-direction: column; }
        .stat-card { background: var(--card); border-radius: 20px; padding: 25px; border: 1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.03); margin-bottom: 20px; transition: 0.3s; }
        .nav-link { color: #888; padding: 12px 20px; border-radius: 12px; margin-bottom: 5px; cursor: pointer; transition: 0.2s; }
        .nav-link:hover, .nav-link.active { background: rgba(59, 130, 246, 0.15); color: var(--primary); font-weight: 600; transform: translateX(5px); }
        .form-control, .form-select { background: var(--input-bg); border: 1px solid var(--border); color: var(--text); padding: 12px; border-radius: 10px; }
        .form-control:focus, .form-select:focus { background: var(--input-bg); color: var(--text); border-color: var(--primary); box-shadow: none; }
        .table { color: var(--text); --bs-table-bg: transparent; }
        .table-hover tbody tr:hover { color: var(--text); background-color: rgba(59, 130, 246, 0.1); }
        [data-theme="dark"] .table-light { background-color: #1a1a1a; color: #fff; }
        [data-theme="dark"] .table-light th { background-color: #1a1a1a; color: #fff; border-color: #333; }
        .btn-system-lock { padding: 10px 20px; border-radius: 50px; font-weight: 700; border: none; transition: 0.3s; }
        .sys-unlocked { background-color: #10B981; color: white; }
        .sys-locked { background-color: #EF4444; color: white; animation: pulseRed 2s infinite; }
        .theme-toggle { cursor: pointer; font-size: 1.5rem; padding: 5px 10px; border-radius: 50%; transition: 0.3s; }
        .rank-badge { width: 35px; height: 35px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; color: #000; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        #qr-hidden { display: none; }
        .scout-profile-header { background: linear-gradient(135deg, #3B82F6, #2563EB); color: white; padding: 30px; border-radius: 20px 20px 0 0; text-align: center; }
        .profile-avatar { width: 80px; height: 80px; background: white; color: var(--primary); border-radius: 50%; font-size: 35px; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; border: 4px solid rgba(255,255,255,0.3); }
        .footer { margin-top: auto; padding-top: 30px; text-align: center; color: #555; font-size: 0.8rem; font-weight: 500; }
        @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } }
        .common-data-box { background: rgba(59, 130, 246, 0.1); border: 1px solid var(--primary); padding: 15px; border-radius: 15px; margin-bottom: 20px; }
        .admin-only, .mod-allowed { display: block; }
    </style>
</head>
<body>

<div id="qr-hidden"></div>
<input type="file" id="importFile" style="display:none" onchange="importData(this)" accept=".json">

<div class="sidebar">
    <div class="brand mb-4 text-primary fw-bold fs-4"><i class="bi bi-shield-lock-fill"></i> ScoutPass</div>
    <div class="nav flex-column">
        <div class="nav-link active" onclick="showSection('overview')"><i class="bi bi-grid-1x2-fill me-2"></i> War Room</div>
        <div class="nav-link text-danger fw-bold" onclick="showSection('alerts')"><i class="bi bi-bell-fill me-2"></i> Alerts <span id="alertBadge" class="badge bg-danger ms-2" style="display:none">0</span></div>
        <div class="nav-link" onclick="showSection('registration')"><i class="bi bi-person-plus-fill me-2"></i> Registration</div>
        <div class="nav-link" onclick="showSection('directory')"><i class="bi bi-search me-2"></i> Directory</div>
        <div class="nav-link" onclick="showSection('events')"><i class="bi bi-calendar-event-fill me-2"></i> Events</div>
        <div class="nav-link admin-only" onclick="showSection('staff')"><i class="bi bi-people-fill me-2"></i> Staff Manager</div>
        <div class="nav-link" onclick="showSection('reports')"><i class="bi bi-file-earmark-pdf-fill me-2"></i> Reports</div>
        <div class="nav-link mt-3 text-dark fw-bold admin-only" onclick="showSection('settings')"><i class="bi bi-gear-fill me-2"></i> Settings</div>
        <div class="nav-link mt-4 text-danger" onclick="logout()"><i class="bi bi-box-arrow-left me-2"></i> Logout</div>
    </div>
</div>

<div class="main-content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold mb-0" id="pageTitle">WAR ROOM</h2>
            <small class="text-muted">System Online • <span id="clock">Loading...</span> • <span id="roleDisplay" class="badge bg-secondary">...</span></small>
        </div>
        <div class="d-flex gap-3 align-items-center">
            <i class="bi bi-moon-stars-fill theme-toggle" onclick="toggleTheme()" id="themeIcon"></i>
            <button id="globalLockBtn" class="btn-system-lock sys-unlocked admin-only" onclick="toggleScannerLock()">
                <i class="bi bi-unlock-fill"></i> Scanners Active
            </button>
        </div>
    </div>

    <div id="sec-overview" class="section animate__animated animate__fadeIn">
        <div class="row g-4">
            <div class="col-md-3"><div class="stat-card"><h6 class="text-muted fw-bold small">TOTAL REGISTERED</h6><h2 class="fw-bold mb-0" id="statTotal">0</h2></div></div>
            <div class="col-md-3"><div class="stat-card"><h6 class="text-muted fw-bold small">TOTAL SCANS</h6><h2 class="fw-bold mb-0" id="statScans">0</h2></div></div>
            <div class="col-md-3"><div class="stat-card border border-success"><h6 class="text-success fw-bold small">ONLINE STAFF</h6><h2 class="fw-bold mb-0 text-success" id="statOnline">0</h2></div></div>
            <div class="col-md-3"><div class="stat-card border border-primary"><h6 class="text-primary fw-bold small">INSIDE (MAIN GATE)</h6><h2 class="fw-bold mb-0 text-primary" id="statInside">0</h2></div></div>
        </div>
        <h5 class="fw-bold mt-4 mb-3">Live Event Dashboard</h5>
        <div id="liveEventCards" class="row g-4"><div class="col-12 text-center text-muted py-5">Loading events...</div></div>
    </div>

    <div id="sec-alerts" class="section animate__animated animate__fadeIn" style="display:none;">
        <div class="stat-card border-danger border-top border-5">
            <div class="d-flex justify-content-between mb-4"><h5 class="fw-bold text-danger">Critical Alerts</h5><button onclick="clearAlerts()" class="btn btn-sm btn-outline-secondary admin-only">Clear All</button></div>
            <div class="table-responsive"><table class="table align-middle"><tbody id="alertsTableBody"><tr><td colspan="4" class="text-center text-muted py-4">No active alerts.</td></tr></tbody></table></div>
        </div>
    </div>

    <div id="sec-registration" class="section animate__animated animate__fadeIn" style="display:none;">
        <div class="stat-card admin-only">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="fw-bold mb-0"><i class="bi bi-person-vcard-fill text-primary"></i> Direct Registration</h4>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-success btn-sm" onclick="exportData()"><i class="bi bi-download"></i> Export DB</button>
                    <button class="btn btn-outline-warning btn-sm" onclick="document.getElementById('importFile').click()"><i class="bi bi-upload"></i> Import DB</button>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="common-data-box">
                        <h6 class="fw-bold text-primary mb-2">Input Format (CSV)</h6>
                        <p class="small text-muted mb-0">Enter one student per line: <br><code class="fw-bold text-dark">RegistrationNo, Name</code></p>
                        <p class="small text-muted">Example: <code>KG15/001, Kamal Perera</code></p>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2"><h6 class="fw-bold">Paste List Here</h6><span class="badge bg-dark">Count: <span id="pasteCount" class="text-warning">0</span></span></div>
                    <textarea id="bulkText" class="form-control mb-3" rows="10" placeholder="KG15/001, Kamal Perera&#10;KG15/002, Nimal Silva" oninput="updatePasteCount()"></textarea>
                    <div class="progress mb-3" style="display:none" id="bulkProgress"><div class="progress-bar bg-success" style="width: 0%"></div></div>
                    <button class="btn btn-primary w-100 fw-bold py-3" onclick="processBulkSafely()">PROCESS & DOWNLOAD IDs</button>
                </div>
                <div class="col-md-6"><h6 class="fw-bold mb-2">Recently Added</h6><div style="max-height: 350px; overflow-y: auto; border:1px solid #333; border-radius:10px;"><table class="table table-sm table-striped mb-0"><thead class="table-dark" style="position: sticky; top: 0;"><tr><th>Reg No</th><th>Name</th></tr></thead><tbody id="regTable"></tbody></table></div></div>
            </div>
        </div>
        <div class="stat-card read-only-msg" style="display:none; text-align:center; padding:50px;"><i class="bi bi-eye-slash-fill fs-1 text-muted"></i><h4 class="mt-3 text-muted">View Only Mode</h4></div>
    </div>

    <div id="sec-directory" class="section animate__animated animate__fadeIn" style="display:none;">
        <div class="stat-card">
            <input type="text" id="searchDir" class="form-control" placeholder="Search ID or Name..." onkeyup="filterDirectory()">
            <div class="table-responsive mt-3"><table class="table align-middle table-hover"><thead><tr><th>ID</th><th>Name</th><th>Troop</th><th>Status</th></tr></thead><tbody id="dirTable"></tbody></table></div>
        </div>
    </div>

    <div id="sec-events" class="section animate__animated animate__fadeIn" style="display:none;">
        <div class="row">
            <div class="col-md-4 mod-allowed">
                <div class="stat-card">
                    <h5 class="fw-bold">Add Event</h5>
                    <label class="small fw-bold text-muted">Event Type</label>
                    <select id="evtType" class="form-select mb-2" onchange="updateButtonPlaceholder()"><option value="ACCESS">Entrance (IN/OUT)</option><option value="ONETIME">Activity (One-Time)</option><option value="CUSTOM">Custom Buttons</option></select>
                    
                    <label class="small fw-bold text-muted">Event Name</label>
                    <input type="text" id="evtName" class="form-control mb-2" placeholder="Ex: Main Gate">
                    
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="evtOneTime">
                        <label class="form-check-label small fw-bold text-muted" for="evtOneTime">One-Time Only (1 Per Scout)</label>
                    </div>

                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="evtVisible" checked>
                        <label class="form-check-label small fw-bold text-muted" for="evtVisible">Show in War Room & App</label>
                    </div>

                    <label class="small fw-bold text-muted">Action Buttons</label>
                    <input type="text" id="evtButtons" class="form-control mb-2" value="IN,OUT" placeholder="Ex: IN, OUT">
                    <label class="small fw-bold text-muted">Points</label>
                    <input type="number" id="evtPoints" class="form-control mb-2" placeholder="0">
                    <button onclick="addEvent()" class="btn btn-success w-100 fw-bold mt-2">Create Event</button>
                </div>
            </div>
            <div class="col-md-8"><div class="stat-card"><h6 class="fw-bold mb-3">Active Events</h6><div id="eventsList"></div></div></div>
        </div>
    </div>

    <div id="sec-staff" class="section animate__animated animate__fadeIn" style="display:none;">
        <div class="row">
            <div class="col-md-4 admin-only">
                <div class="stat-card">
                    <h5 class="fw-bold">Add Staff</h5>
                    <input type="email" id="stfEmail" class="form-control mb-2" placeholder="Email">
                    <input type="text" id="stfPass" class="form-control mb-2" placeholder="Password">
                    <select id="stfRole" class="form-select mb-2"><option value="scanner">Scanner (App Only)</option><option value="viewer">Viewer (Read Only)</option><option value="moderator">Moderator (View + Add Event)</option><option value="admin">Admin (Full Access)</option></select>
                    <button onclick="addStaff()" class="btn btn-dark w-100 fw-bold">Create Account</button>
                </div>
            </div>
            <div class="col-md-8"><div class="stat-card"><table class="table align-middle"><tbody id="staffTable"></tbody></table></div></div>
        </div>
    </div>

    <div id="sec-reports" class="section animate__animated animate__fadeIn" style="display:none;">
        <div class="stat-card text-center py-5">
            <h5 class="fw-bold mb-3">On-Demand Reports</h5>
            <p class="text-muted mb-4">Click below to fetch data and generate reports. This saves bandwidth.</p>
            <div class="row g-2 justify-content-center">
                <div class="col-md-4">
                    <button onclick="exportLogsPDF()" class="btn btn-danger w-100 fw-bold py-3"><i class="bi bi-file-earmark-pdf-fill"></i> Download Full PDF</button>
                </div>
            </div>
            <div class="mt-4" id="reportStatus"></div>
        </div>
    </div>

    <div id="sec-settings" class="section animate__animated animate__fadeIn" style="display:none;">
        <div class="stat-card border-danger border-start border-5 mb-4"><h3 class="fw-bold text-danger mb-3">Danger Zone</h3><button onclick="initiateSystemReset()" class="btn btn-danger fw-bold">RESET SYSTEM DATABASE</button></div>
        
        <div class="stat-card border-warning border-start border-5">
            <h5 class="fw-bold text-warning mb-3">Maintenance Tools</h5>
            <p class="small text-muted">Use this if the dashboard shows "0" but you have past logs.</p>
            <button onclick="forceRecalculateStats()" class="btn btn-warning w-100 fw-bold">
                <i class="bi bi-arrow-repeat"></i> Sync / Fix Stats from Logs
            </button>
        </div>
    </div>

    <div class="footer">ScoutPass | Developed by Madhawa Basanayake</div>
</div>

<div class="offcanvas offcanvas-end" tabindex="-1" id="scoutOffcanvas" style="width: 400px;">
    <div class="offcanvas-header bg-light"><h5 class="offcanvas-title fw-bold">Scout Profile</h5><button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button></div>
    <div class="offcanvas-body p-0">
        <div class="scout-profile-header"><div class="profile-avatar"><i class="bi bi-person-fill"></i></div><h4 class="fw-bold mb-0" id="panelName">Loading...</h4><div class="badge bg-white text-primary mt-2 fs-6" id="panelID">ID: ---</div></div>
        <div class="p-4">
            <div class="row text-center mb-4"><div class="col-12"><h5 class="fw-bold mb-0" id="panelTroop">-</h5><small class="text-muted fw-bold">TROOP</small></div></div>
            <div class="d-grid gap-2 mb-4 admin-only">
                <button id="btnToggleMissing" class="btn btn-outline-danger" onclick="toggleMissingFromPanel()">Mark as Missing</button>
                <button onclick="downloadSingleID()" class="btn btn-dark">Download ID Card</button>
                <button onclick="deleteScoutFromPanel()" class="btn btn-outline-danger">Delete Profile</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signOut, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, onValue, set, push, serverTimestamp, get, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = { apiKey: "AIzaSyCIrXtwckl-4RPOXDn5IOMiHFh_uXdPiKQ", authDomain: "scoutpass-276cb.firebaseapp.com", projectId: "scoutpass-276cb", databaseURL: "https://scoutpass-276cb-default-rtdb.asia-southeast1.firebasedatabase.app/" };
    const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getDatabase(app); const secondaryApp = initializeApp(firebaseConfig, "Secondary"); const secondaryAuth = getAuth(secondaryApp);

    setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString(); }, 1000);

    let allScouts=[], allEvents=[], currentStats={}, lastBatchScouts=[]; let isScannerLocked = false; let selectedScoutData = null; let currentUserRole = 'admin';

    onAuthStateChanged(auth, async (user) => { 
        if (!user) window.location.href = "index.html"; 
        else { 
            const snap = await get(ref(db, `users/${user.uid}`));
            if(snap.exists()) {
                currentUserRole = snap.val().role || 'admin';
                document.getElementById('roleDisplay').innerText = currentUserRole.toUpperCase();
                if(currentUserRole === 'scanner') { document.body.innerHTML = "<h1 style='text-align:center;margin-top:20%'>Access Denied<br>Use Mobile App</h1>"; return; }
                applyPermissions();
            }
            set(ref(db, `presence/${user.uid}`), { email: user.email, online: true }); 
        } 
    });

    function applyPermissions() {
        const adminEls = document.querySelectorAll('.admin-only'); const modEls = document.querySelectorAll('.mod-allowed'); const readOnlyMsgs = document.querySelectorAll('.read-only-msg');
        if (currentUserRole === 'admin') { adminEls.forEach(el => el.style.display = 'block'); modEls.forEach(el => el.style.display = 'block'); readOnlyMsgs.forEach(el => el.style.display = 'none'); } 
        else if (currentUserRole === 'moderator') { adminEls.forEach(el => el.style.display = 'none'); modEls.forEach(el => el.style.display = 'block'); readOnlyMsgs.forEach(el => el.style.display = 'block'); } 
        else if (currentUserRole === 'viewer') { adminEls.forEach(el => el.style.display = 'none'); modEls.forEach(el => el.style.display = 'none'); readOnlyMsgs.forEach(el => el.style.display = 'block'); }
    }

    window.toggleTheme = () => { const body = document.body; const icon = document.getElementById('themeIcon'); if(body.getAttribute('data-theme') === 'dark') { body.removeAttribute('data-theme'); icon.className = 'bi bi-moon-stars-fill theme-toggle'; localStorage.setItem('theme', 'light'); } else { body.setAttribute('data-theme', 'dark'); icon.className = 'bi bi-sun-fill theme-toggle text-warning'; localStorage.setItem('theme', 'dark'); } }
    if(localStorage.getItem('theme') === 'dark') window.toggleTheme();

    const systemRef = ref(db, 'system_settings/scanning_active');
    onValue(systemRef, (snapshot) => { const isActive = snapshot.val(); isScannerLocked = !isActive; const btn = document.getElementById("globalLockBtn"); if (isActive) { btn.className = "btn-system-lock sys-unlocked admin-only"; btn.innerHTML = '<i class="bi bi-unlock-fill"></i> Scanners Active'; } else { btn.className = "btn-system-lock sys-locked admin-only"; btn.innerHTML = '<i class="bi bi-lock-fill"></i> SCANNERS LOCKED'; } applyPermissions(); });
    window.toggleScannerLock = () => set(systemRef, isScannerLocked);

    onValue(ref(db, 'alerts'), (snap) => { const tbody = document.getElementById('alertsTableBody'); const badge = document.getElementById('alertBadge'); tbody.innerHTML = ""; if (snap.exists()) { const alerts = Object.entries(snap.val()); badge.innerText = alerts.length; badge.style.display = 'inline-block'; alerts.reverse().forEach(([key, alert]) => { tbody.innerHTML += `<tr><td class="fw-bold text-danger">${new Date(alert.timestamp).toLocaleTimeString()}</td><td><strong class="text-danger">MISSING FOUND!</strong><br>${alert.scoutName}</td><td>${alert.location}</td><td><button class="btn btn-sm btn-dark admin-only" onclick="resolveAlert('${key}')">Mark Safe</button></td></tr>`; }); if(currentUserRole!=='viewer') Swal.fire({toast:true, position:'top-end', icon:'warning', title:'⚠️ Alert Triggered!'}); applyPermissions(); } else { badge.style.display = 'none'; tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted py-4">No active alerts.</td></tr>`; } });
    window.resolveAlert = (key) => remove(ref(db, `alerts/${key}`)); window.clearAlerts = () => remove(ref(db, 'alerts'));

    // --- MAIN DASHBOARD RENDER LOGIC ---
    function renderDashboard() {
        // Global Counters
        document.getElementById('statScans').innerText = currentStats.total_scans || 0;
        document.getElementById('statInside').innerText = currentStats.inside_count || 0;

        const container = document.getElementById('liveEventCards'); 
        container.innerHTML = ""; 

        if (allEvents.length === 0) { 
            container.innerHTML = `<div class="col-12 text-center py-5">No events created.</div>`; 
            return; 
        }

        allEvents.forEach(evt => {
            if(evt.isDeleted || evt.isVisible === false) return;

            // Get Stats (Default to empty object if not found)
            const evtStats = (currentStats.events && currentStats.events[evt.name]) ? currentStats.events[evt.name] : {};
            
            let badgeType = evt.type || "ACTIVITY";
            let bodyHtml = '';

            // TYPE 1: GATE / ACCESS (IN, OUT, INSIDE)
            if (badgeType === 'ACCESS' || (evt.buttons && evt.buttons.includes('IN'))) {
                const inCount = evtStats.in || 0;
                const outCount = evtStats.out || 0;
                const inside = inCount - outCount;

                bodyHtml = `
                    <div class="row text-center mt-4">
                        <div class="col-4 border-end">
                            <h3 class="fw-bold mb-0">${inCount}</h3>
                            <small class="text-muted fw-bold" style="font-size:0.7rem">IN</small>
                        </div>
                        <div class="col-4 border-end">
                            <h3 class="fw-bold mb-0">${outCount}</h3>
                            <small class="text-muted fw-bold" style="font-size:0.7rem">OUT</small>
                        </div>
                        <div class="col-4">
                            <h3 class="fw-bold text-primary mb-0">${Math.max(0, inside)}</h3>
                            <small class="text-primary fw-bold" style="font-size:0.7rem">INSIDE</small>
                        </div>
                    </div>`;
            } 
            // TYPE 2: ACTIVITY (TOTAL ONLY)
            else {
                const count = evtStats.completed || 0;
                bodyHtml = `
                    <div class="text-center mt-4 pb-2">
                        <h2 class="text-success display-5 fw-bold mb-0">${count}</h2>
                        <small class="text-muted fw-bold text-uppercase" style="font-size:0.7rem">Completed Scans</small>
                    </div>`;
            }

            container.innerHTML += `
                <div class="col-md-6 col-lg-4">
                    <div class="stat-card border-top border-4 border-primary h-100 position-relative">
                        <div class="d-flex justify-content-between align-items-start">
                            <h5 class="fw-bold mb-0 text-truncate" style="max-width:75%">${evt.name}</h5>
                            <span class="badge bg-light text-dark border">${badgeType}</span>
                        </div>
                        ${bodyHtml}
                    </div>
                </div>`;
        });
    }

    // LISTENER: STATS (Updates counters & triggers render)
    onValue(ref(db, 'stats'), (s) => { 
        currentStats = s.val() || {};
        renderDashboard();
    });

    // LISTENER: EVENTS (Updates list & triggers render)
    onValue(ref(db, 'events'), (s) => { 
        const data = s.val(); 
        allEvents = data ? Object.entries(data).map(([key, val]) => ({key, ...val})) : []; 
        
        // Render Events List in Tab
        let h = ''; 
        allEvents.forEach(e => { 
            if (e.isDeleted) return;
            const btns = e.buttons ? e.buttons.map(b=>`<span class="badge bg-light text-dark border ms-1">${b}</span>`).join('') : ''; 
            const pointsTag = e.points > 0 ? `<span class="badge bg-success border ms-2">${e.points} PTS</span>` : '';
            const oneTimeTag = e.isOneTime ? `<span class="badge bg-danger ms-1">1-TIME</span>` : '';
            const isVis = (e.isVisible === undefined) ? true : e.isVisible; 
            const checkedState = isVis ? 'checked' : '';
            h += `<div class="d-flex justify-content-between align-items-center border-bottom p-2"><div><span class="fw-bold text-primary">${e.name}</span>${pointsTag}${oneTimeTag}<div class="small text-muted mt-1">Buttons:${btns}</div></div><div class="d-flex align-items-center gap-2"><div class="form-check form-switch mod-allowed"><input class="form-check-input" type="checkbox" onchange="toggleEventVisibility('${e.key}', this.checked)" ${checkedState}></div><button onclick="removeEvent('${e.key}')" class="btn btn-sm text-danger admin-only"><i class="bi bi-trash"></i></button></div></div>`; 
        }); 
        document.getElementById('eventsList').innerHTML = h; 
        
        // Render Dashboard Cards
        renderDashboard();
        applyPermissions(); 
    });

    window.toggleEventVisibility = async (key, status) => { await update(ref(db, `events/${key}`), { isVisible: status }); };

    function updateDirectoryPoints() {
        let h = ''; 
        allScouts.slice().reverse().slice(0,100).forEach(sc => { 
            const safeKey = sc.id.replace(/[.#$/[\]]/g, '_'); 
            const status = sc.isMissing ? '<span class="badge bg-danger">MISSING</span>' : '<span class="badge bg-success">Active</span>'; 
            h += `<tr style="cursor:pointer" onclick="viewScout('${safeKey}')"><td>${sc.id}</td><td class="fw-bold text-primary">${sc.name}</td><td>${sc.troop||'-'}</td><td>${status}</td></tr>`; 
        }); 
        document.getElementById('dirTable').innerHTML = h;
    }

    // --- ON DEMAND EXPORT FUNCTION ---
    window.exportLogsPDF = async () => { 
        Swal.fire({ title: 'Downloading Data...', text: 'Fetching logs from server. Please wait.', didOpen: () => Swal.showLoading() });
        try {
            const snap = await get(ref(db, 'logs'));
            if (!snap.exists()) throw new Error("No logs found.");
            const logs = Object.values(snap.val());
            const { jsPDF } = window.jspdf; 
            const doc = new jsPDF(); 
            doc.autoTable({ head: [['Time', 'Scout', 'Event', 'Action']], body: logs.map(l => [new Date(l.timestamp).toLocaleTimeString(), l.scoutName, l.eventName, l.action]) }); 
            doc.save(`Full_Logs_Report.pdf`);
            Swal.fire('Success', 'PDF Downloaded', 'success');
        } catch (e) {
            Swal.fire('Error', e.message, 'error');
        }
    }

    // --- SYNC / RECALCULATE STATS FUNCTION ---
    window.forceRecalculateStats = async () => {
        Swal.fire({ title: 'Syncing...', text: 'Recalculating statistics from logs...', didOpen: () => Swal.showLoading() });
        try {
            const logSnap = await get(ref(db, 'logs'));
            if (!logSnap.exists()) return Swal.fire('No Logs', 'Nothing to sync.', 'info');
            const logs = Object.values(logSnap.val());

            let newStats = { total_scans: 0, inside_count: 0, events: {} };

            logs.forEach(l => {
                newStats.total_scans++;
                if (!newStats.events[l.eventName]) newStats.events[l.eventName] = { in:0, out:0, completed:0 };

                if (l.action === 'IN') {
                    newStats.events[l.eventName].in++;
                    newStats.inside_count++;
                } else if (l.action === 'OUT') {
                    newStats.events[l.eventName].out++;
                    newStats.inside_count--;
                } else {
                    newStats.events[l.eventName].completed++;
                }
            });

            await set(ref(db, 'stats'), newStats);
            Swal.fire('Success', 'Dashboard Synced with Logs!', 'success');
        } catch (e) {
            Swal.fire('Error', e.message, 'error');
        }
    };

    window.updatePasteCount = function() { document.getElementById('pasteCount').innerText = document.getElementById('bulkText').value.split('\n').filter(line => line.trim() !== '').length; };
    window.processBulkSafely = async function() { const text = document.getElementById('bulkText').value; if(!text.trim()) return Swal.fire('Error', 'Paste the data first!', 'error'); const lines = text.trim().split('\n').filter(l => l.trim() !== ''); document.getElementById('bulkProgress').style.display = 'flex'; lastBatchScouts = []; let successCount = 0; try { const updates = {}; lines.forEach(line => { const parts = line.split(','); if(parts.length >= 2) { const regNo = parts[0].trim(); const name = parts.slice(1).join(',').trim(); if(regNo && name) { const safeKey = regNo.replace(/[.#$/[\]]/g, '_'); const scoutObj = { id: regNo, name: name, troop: "-", points: 0, isMissing: false, regDate: serverTimestamp() }; updates[`scouts/${safeKey}`] = scoutObj; lastBatchScouts.push(scoutObj); successCount++; } } }); if (Object.keys(updates).length > 0) { await update(ref(db), updates); } document.getElementById('bulkProgress').querySelector('.progress-bar').style.width = '100%'; updateRecentTable(lastBatchScouts); document.getElementById('bulkText').value = ''; Swal.fire({ icon: 'success', title: 'Done', text: `Registered ${successCount} scouts.` }); downloadBatchPDF(lastBatchScouts, `IDs_Export`); } catch(e) { Swal.fire('Error', e.message, 'error'); } finally { setTimeout(() => { document.getElementById('bulkProgress').style.display = 'none'; }, 2000); } };

    window.addStaff = async () => { const e=document.getElementById('stfEmail').value, p=document.getElementById('stfPass').value, r=document.getElementById('stfRole').value; if(e&&p) { try { const c = await createUserWithEmailAndPassword(secondaryAuth, e, p); await set(ref(db, `users/${c.user.uid}`), { email:e, role:r }); Swal.fire('Success', 'Staff Account Created', 'success'); } catch(err) { Swal.fire('Error', err.message, 'error'); } } };
    onValue(ref(db, 'users'), (s) => { const tbody = document.getElementById('staffTable'); tbody.innerHTML = ""; if (s.exists()) { Object.entries(s.val()).forEach(([uid, u]) => { tbody.innerHTML += `<tr><td>${u.email}</td><td><span class="badge bg-dark">${u.role}</span></td><td><button class="btn btn-sm btn-outline-danger admin-only" onclick="removeUser('${uid}')"><i class="bi bi-trash"></i></button></td></tr>`; }); } applyPermissions(); });
    window.removeUser = (uid) => remove(ref(db, `users/${uid}`));
    
    onValue(ref(db, 'scouts'), (s) => { allScouts = s.exists() ? Object.values(s.val()) : []; document.getElementById('statTotal').innerText = allScouts.length; updateDirectoryPoints(); });

    window.updateButtonPlaceholder = () => { const t = document.getElementById('evtType').value; const b = document.getElementById('evtButtons'); if(t === 'ACCESS') b.value = "IN,OUT"; else if(t === 'ONETIME') b.value = "SCAN"; else b.value = ""; }
    
    window.addEvent = async () => { 
        const n=document.getElementById('evtName').value, p=document.getElementById('evtPoints').value, t=document.getElementById('evtType').value, b=document.getElementById('evtButtons').value, isOneTime=document.getElementById('evtOneTime').checked;
        const isVisible = document.getElementById('evtVisible').checked; // Read Switch
        const bArray = b ? b.split(',').map(s=>s.trim()) : ['SCAN']; 
        if(n) { 
            await push(ref(db, 'events'), {name:n, points:p, type:t, buttons:bArray, active:true, isOneTime:isOneTime, isVisible: isVisible, isDeleted: false}); 
            Swal.fire({icon:'success', title:'Event Created', timer:1500, showConfirmButton:false}); 
            document.getElementById('evtName').value = ''; document.getElementById('evtOneTime').checked = false; document.getElementById('evtVisible').checked = true;
        } 
    }
    
    window.removeEvent = async (k) => {
        const { value: password } = await Swal.fire({ title: 'Enter Admin Password', input: 'password', inputPlaceholder: 'Code (2004)', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Archive Event' });
        if (password === '2004') { await update(ref(db, `events/${k}`), { isDeleted: true, active: false }); Swal.fire({icon:'info', title:'Archived', text:'Event hidden, but points preserved.', timer:1500, showConfirmButton:false}); } 
        else if (password) { Swal.fire('Error', 'Invalid Password', 'error'); }
    }

    onValue(ref(db, 'presence'), (snap) => { document.getElementById('statOnline').innerText = snap.exists() ? Object.keys(snap.val()).length : 0; });
    
    function updateRecentTable(list) { let h=''; list.slice().reverse().forEach(s=>{ h+=`<tr><td>${s.id}</td><td>${s.name}</td></tr>`}); document.getElementById('regTable').innerHTML=h; }
    
    window.downloadBatchPDF = function(scoutList, filename) { if(!scoutList || scoutList.length === 0) return; const { jsPDF } = window.jspdf; const doc = new jsPDF(); const cardW = 45, cardH = 65, marginX = 15, marginY = 15, gap = 2; let col = 0, row = 0; const qrDiv = document.getElementById('qr-hidden'); scoutList.forEach((s, i) => { if(i > 0 && i % 16 === 0) { doc.addPage(); col = 0; row = 0; } qrDiv.innerHTML = ""; new QRCode(qrDiv, { text: s.id, width: 200, height: 200, correctLevel: QRCode.CorrectLevel.H }); const img = qrDiv.querySelector('canvas').toDataURL("image/png"); const curX = marginX + (col * (cardW + gap)); const curY = marginY + (row * (cardH + gap)); const centerX = curX + (cardW/2); doc.setLineWidth(0.1); doc.rect(curX, curY, cardW, cardH); doc.setFont("helvetica", "bold"); doc.setFontSize(9); doc.text("SCOUT PASS", centerX, curY + 6, {align:'center'}); doc.addImage(img, 'PNG', curX + (cardW - 35)/2, curY + 9, 35, 35); doc.setFont("helvetica", "bold"); doc.setFontSize(11); doc.text(s.id, centerX, curY + 50, {align:'center'}); doc.setFont("helvetica", "normal"); doc.setFontSize(9); let printName = s.name.length > 20 ? s.name.substring(0,18) + '..' : s.name; doc.text(printName, centerX, curY + 56, {align:'center'}); doc.setFontSize(6); doc.setTextColor(150); doc.text("SCAN TO VERIFY", centerX, curY + 62, {align:'center'}); doc.setTextColor(0); col++; if(col >= 4) { col = 0; row++; } }); doc.save(filename ? `${filename}.pdf` : `Scout_IDs.pdf`); }
    window.exportData = function() { if(allScouts.length === 0) return Swal.fire('Empty', 'No data to export', 'info'); const dataStr = JSON.stringify(allScouts, null, 2); const blob = new Blob([dataStr], {type: "application/json"}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `ScoutDB_Backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); }
    window.importData = function(input) { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = async function(e) { try { const data = JSON.parse(e.target.result); if(!Array.isArray(data)) throw new Error("Invalid Format"); const updates = {}; data.forEach(s => { const safeKey = s.id.replace(/[.#$/[\]]/g, '_'); updates[`scouts/${safeKey}`] = s; }); await update(ref(db), updates); Swal.fire('Success', `Restored ${data.length} records.`, 'success'); } catch(err) { Swal.fire('Error', 'Invalid File Format', 'error'); } input.value = ''; }; reader.readAsText(file); }
    window.showSection = (id) => { document.querySelectorAll('.section').forEach(d=>d.style.display='none'); document.getElementById('sec-'+id).style.display='block'; document.getElementById('pageTitle').innerText = id.toUpperCase(); };
    window.logout = () => signOut(auth).then(()=>window.location.href="index.html"); window.filterDirectory = () => { const term = document.getElementById('searchDir').value.toLowerCase(); document.querySelectorAll('#dirTable tr').forEach(row => { row.style.display = row.innerText.toLowerCase().includes(term) ? '' : 'none'; }); };
    
    window.initiateSystemReset = async () => { const { value: code } = await Swal.fire({ title: '⚠️ SYSTEM RESET', input: 'password', inputLabel: 'Enter Admin Password', inputPlaceholder: 'Password', confirmButtonText: 'Verify', confirmButtonColor: '#d33', showCancelButton: true }); if (code === 'MadhawaBasnayake@20041110') { const result = await Swal.fire({ title: 'Are you sure?', text: "This will delete ALL Scouts, Logs, and Events. Staff accounts will remain.", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#3085d6', confirmButtonText: 'Yes, WIPE EVERYTHING!' }); if (result.isConfirmed) { try { await remove(ref(db, 'scouts')); await remove(ref(db, 'logs')); await remove(ref(db, 'events')); await remove(ref(db, 'alerts')); await remove(ref(db, 'special_codes')); await remove(ref(db, 'stats')); await set(ref(db, 'system/scoutCounter'), 0); Swal.fire('WIPED!', 'System has been reset successfully.', 'success'); } catch (error) { Swal.fire('Error', error.message, 'error'); } } } else if (code) { Swal.fire('Error', 'Invalid Admin Password!', 'error'); } };

    window.viewScout = (safeKey) => { const sc = allScouts.find(s => s.id.replace(/[.#$/[\]]/g, '_') === safeKey); if(sc) { document.getElementById('panelName').innerText = sc.name; document.getElementById('panelID').innerText = sc.id; document.getElementById('panelTroop').innerText = sc.troop || '-'; selectedScoutData = sc; const btn = document.getElementById('btnToggleMissing'); if(sc.isMissing) { btn.className = "btn btn-success"; btn.innerText = "Mark as Safe"; } else { btn.className = "btn btn-outline-danger"; btn.innerText = "Mark as Missing"; } new bootstrap.Offcanvas(document.getElementById('scoutOffcanvas')).show(); applyPermissions(); } };
    window.toggleMissingFromPanel = async () => { if(!selectedScoutData) return; const safeKey = selectedScoutData.id.replace(/[.#$/[\]]/g, '_'); const newState = !selectedScoutData.isMissing; await update(ref(db, `scouts/${safeKey}`), { isMissing: newState }); if(newState) { push(ref(db, 'alerts'), { scoutName: selectedScoutData.name, location: "Admin Panel Report", timestamp: serverTimestamp() }); Swal.fire({icon: 'warning', title: 'Marked Missing', text: 'Alert Sent!'}); } else { Swal.fire({icon: 'success', title: 'Marked Safe'}); } viewScout(safeKey); };
    window.downloadSingleID = () => downloadBatchPDF([selectedScoutData], `${selectedScoutData.id.replace(/[.#$/[\]]/g, '_')}`); window.deleteScoutFromPanel = async () => { if(!selectedScoutData) return; await remove(ref(db, `scouts/${selectedScoutData.id.replace(/[.#$/[\]]/g, '_')}`)); bootstrap.Offcanvas.getInstance(document.getElementById('scoutOffcanvas')).hide(); }; 
</script>
</body>
</html>
