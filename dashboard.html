<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scout Pass | Command Center V25</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root { --primary: #6c5ce7; --bg: #f5f6fa; --card: #ffffff; --text: #2d3436; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Outfit', sans-serif; transition: 0.3s; }
        .sidebar { position: fixed; height: 100vh; width: 260px; background: var(--card); padding: 20px; z-index: 100; border-right: 1px solid rgba(0,0,0,0.05); }
        .main-content { margin-left: 260px; padding: 30px; min-height: 100vh; display: flex; flex-direction: column; }
        .stat-card { background: var(--card); border-radius: 20px; padding: 25px; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.03); margin-bottom: 20px; transition: 0.3s; }
        .nav-link { color: #888; padding: 12px 20px; border-radius: 12px; margin-bottom: 5px; cursor: pointer; transition: 0.2s; }
        .nav-link:hover, .nav-link.active { background: rgba(108, 92, 231, 0.1); color: var(--primary); font-weight: 600; transform: translateX(5px); }
        .form-control, .form-select { background: #f8f9fa; border: 1px solid #eee; color: var(--text); padding: 12px; border-radius: 10px; }
        .btn-system-lock { padding: 10px 20px; border-radius: 50px; font-weight: 700; border: none; transition: 0.3s; }
        .sys-unlocked { background-color: #00b894; color: white; }
        .sys-locked { background-color: #d63031; color: white; animation: pulseRed 2s infinite; }
        #qr-hidden { display: none; }
        .scout-profile-header { background: linear-gradient(135deg, #6c5ce7, #a29bfe); color: white; padding: 30px; border-radius: 20px 20px 0 0; text-align: center; }
        .profile-avatar { width: 80px; height: 80px; background: white; color: var(--primary); border-radius: 50%; font-size: 35px; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; border: 4px solid rgba(255,255,255,0.3); }
        .footer { margin-top: auto; padding-top: 30px; text-align: center; color: #b2bec3; font-size: 0.8rem; font-weight: 500; }
        @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(214, 48, 49, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(214, 48, 49, 0); } }
        .common-data-box { background: #e3f2fd; border: 1px solid #90caf9; padding: 15px; border-radius: 15px; margin-bottom: 20px; }
    </style>
</head>
<body>

<div id="qr-hidden"></div>
<div class="sidebar">
    <div class="brand mb-4 text-primary fw-bold fs-4"><i class="bi bi-shield-lock-fill"></i> ScoutPass</div>
    <div class="nav flex-column">
        <div class="nav-link active" onclick="showSection('overview')"><i class="bi bi-grid-1x2-fill me-2"></i> War Room</div>
        <div class="nav-link text-danger fw-bold" onclick="showSection('alerts')"><i class="bi bi-bell-fill me-2"></i> Alerts <span id="alertBadge" class="badge bg-danger ms-2" style="display:none">0</span></div>
        <div class="nav-link" onclick="showSection('livelogs')"><i class="bi bi-activity me-2"></i> Live Logs</div>
        <div class="nav-link" onclick="showSection('registration')"><i class="bi bi-person-plus-fill me-2"></i> Registration</div>
        <div class="nav-link" onclick="showSection('directory')"><i class="bi bi-search me-2"></i> Directory</div>
        <div class="nav-link" onclick="showSection('events')"><i class="bi bi-calendar-event-fill me-2"></i> Events</div>
        <div class="nav-link" onclick="showSection('special')"><i class="bi bi-ticket-perforated-fill me-2"></i> Special QR</div>
        <div class="nav-link" onclick="showSection('staff')"><i class="bi bi-people-fill me-2"></i> Staff Manager</div>
        <div class="nav-link" onclick="showSection('reports')"><i class="bi bi-file-earmark-pdf-fill me-2"></i> Reports</div>
        <div class="nav-link mt-3 text-dark fw-bold" onclick="showSection('settings')"><i class="bi bi-gear-fill me-2"></i> Settings</div>
        <div class="nav-link mt-4 text-danger" onclick="logout()"><i class="bi bi-box-arrow-left me-2"></i> Logout</div>
    </div>
</div>

<div class="main-content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div><h2 class="fw-bold mb-0" id="pageTitle">WAR ROOM</h2><small class="text-muted">System Online • <span id="clock">Loading...</span></small></div>
        <div class="d-flex gap-2"><button id="globalLockBtn" class="btn-system-lock sys-unlocked" onclick="toggleScannerLock()"><i class="bi bi-unlock-fill"></i> Scanners Active</button></div>
    </div>

    <div id="sec-overview" class="section animate__animated animate__fadeIn">
        <div class="row g-4">
            <div class="col-md-3"><div class="stat-card"><h6 class="text-muted fw-bold small">TOTAL REGISTERED</h6><h2 class="fw-bold mb-0" id="statTotal">0</h2></div></div>
            <div class="col-md-3"><div class="stat-card"><h6 class="text-muted fw-bold small">TOTAL SCANS</h6><h2 class="fw-bold mb-0" id="statScans">0</h2></div></div>
            <div class="col-md-3"><div class="stat-card border border-success"><h6 class="text-success fw-bold small">ONLINE STAFF</h6><h2 class="fw-bold mb-0 text-success" id="statOnline">0</h2></div></div>
            <div class="col-md-3"><div class="stat-card border border-primary"><h6 class="text-primary fw-bold small">INSIDE (MAIN GATE)</h6><h2 class="fw-bold mb-0 text-primary" id="statInside">0</h2></div></div>
        </div>
        <h5 class="fw-bold mt-4 mb-3">Live Event Dashboard</h5>
        <div id="liveEventCards" class="row g-4"><div class="col-12 text-center text-muted py-5">Loading events...</div></div>
    </div>

    <div id="sec-alerts" class="section animate__animated animate__fadeIn" style="display:none;">
        <div class="stat-card border-danger border-top border-5">
            <div class="d-flex justify-content-between mb-4"><h5 class="fw-bold text-danger">Critical Alerts</h5><button onclick="clearAlerts()" class="btn btn-sm btn-outline-secondary">Clear All</button></div>
            <div class="table-responsive"><table class="table align-middle"><tbody id="alertsTableBody"><tr><td colspan="4" class="text-center text-muted py-4">No active alerts.</td></tr></tbody></table></div>
        </div>
    </div>

    <div id="sec-livelogs" class="section animate__animated animate__fadeIn" style="display:none;">
        <div class="stat-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-bold text-primary"><i class="bi bi-activity"></i> Real-time Activity Feed</h5>
                <span class="badge bg-success animate__animated animate__pulse animate__infinite">LIVE</span>
            </div>
            <div class="table-responsive" style="max-height: 600px;">
                <table class="table table-hover align-middle">
                    <thead class="table-light" style="position: sticky; top: 0;">
                        <tr><th>Time</th><th>Scout Name</th><th>Event</th><th>Action</th><th>Scanned By</th></tr>
                    </thead>
                    <tbody id="liveLogsBody">
                        <tr><td colspan="5" class="text-center text-muted">Waiting for scans...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="sec-registration" class="section animate__animated animate__fadeIn" style="display:none;">
        <div class="stat-card">
            <h4 class="fw-bold mb-3"><i class="bi bi-person-vcard-fill text-primary"></i> Bulk Registration</h4>
            <div class="common-data-box">
                <h6 class="fw-bold text-primary mb-3">Step 1: Set Common Data</h6>
                <div class="row g-2">
                    <div class="col-md-3"><label class="small fw-bold">District</label><input type="text" id="regDistrict" class="form-control fw-bold" value="Kegalle"></div>
                    <div class="col-md-2"><label class="small fw-bold">Prefix</label><input type="text" id="regPrefix" class="form-control fw-bold text-center" value="KG"></div>
                    <div class="col-md-2"><label class="small fw-bold">Troop No</label><input type="text" id="regTroopNum" class="form-control fw-bold text-center" placeholder="15"></div>
                    <div class="col-md-5"><label class="small fw-bold">Troop Name</label><input type="text" id="regTroopName" class="form-control fw-bold" placeholder="Kegalle Vidyalaya"></div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="d-flex justify-content-between align-items-center mb-2"><h6 class="fw-bold">Step 2: Paste List</h6><span class="badge bg-dark">Count: <span id="pasteCount" class="text-warning">0</span></span></div>
                    <textarea id="bulkText" class="form-control mb-3" rows="10" placeholder="Paste names here..." oninput="updatePasteCount()"></textarea>
                    <div class="progress mb-3" style="display:none" id="bulkProgress"><div class="progress-bar bg-success" style="width: 0%"></div></div>
                    <button class="btn btn-primary w-100 fw-bold py-3" onclick="processBulkSafely()">PROCESS & DOWNLOAD IDs</button>
                </div>
                <div class="col-md-6"><h6 class="fw-bold mb-2">Recently Added</h6><div style="max-height: 350px; overflow-y: auto; border:1px solid #eee; border-radius:10px;"><table class="table table-sm table-striped mb-0"><thead class="table-dark" style="position: sticky; top: 0;"><tr><th>ID</th><th>Name</th></tr></thead><tbody id="regTable"></tbody></table></div></div>
            </div>
        </div>
    </div>

    <div id="sec-directory" class="section animate__animated animate__fadeIn" style="display:none;">
        <div class="stat-card">
            <input type="text" id="searchDir" class="form-control" placeholder="Search ID or Name..." onkeyup="filterDirectory()">
            <div class="table-responsive mt-3"><table class="table align-middle table-hover"><thead><tr><th>ID</th><th>Name</th><th>Troop</th><th>Points</th><th>Status</th></tr></thead><tbody id="dirTable"></tbody></table></div>
        </div>
    </div>

    <div id="sec-events" class="section animate__animated animate__fadeIn" style="display:none;">
        <div class="row">
            <div class="col-md-4">
                <div class="stat-card">
                    <h5 class="fw-bold">Add Event</h5>
                    <label class="small fw-bold text-muted">Event Type</label>
                    <select id="evtType" class="form-select mb-2" onchange="updateButtonPlaceholder()"><option value="ACCESS">Entrance (IN/OUT)</option><option value="ONETIME">Activity (One-Time)</option><option value="CUSTOM">Custom Buttons</option></select>
                    <label class="small fw-bold text-muted">Event Name</label>
                    <input type="text" id="evtName" class="form-control mb-2" placeholder="Ex: Main Gate">
                    <label class="small fw-bold text-muted">Action Buttons</label>
                    <input type="text" id="evtButtons" class="form-control mb-2" value="IN,OUT" placeholder="Ex: IN, OUT">
                    <label class="small fw-bold text-muted">Points</label>
                    <input type="number" id="evtPoints" class="form-control mb-2" placeholder="0">
                    <button onclick="addEvent()" class="btn btn-success w-100 fw-bold mt-2">Create Event</button>
                </div>
            </div>
            <div class="col-md-8"><div class="stat-card"><h6 class="fw-bold mb-3">Active Events</h6><div id="eventsList"></div></div></div>
        </div>
    </div>

    <div id="sec-special" class="section animate__animated animate__fadeIn" style="display:none;">
        <div class="row">
            <div class="col-md-5"><div class="stat-card"><h5 class="fw-bold mb-3">Bonus Token</h5><input type="text" id="spName" class="form-control mb-2" placeholder="Token Name"><input type="number" id="spPoints" class="form-control mb-2" placeholder="Points"><button onclick="createSpecialQR()" class="btn btn-warning w-100 fw-bold">Generate QR</button></div></div>
            <div class="col-md-7"><div class="stat-card"><h6 class="fw-bold">Active Tokens</h6><div id="specialList"></div></div></div>
        </div>
    </div>

    <div id="sec-staff" class="section animate__animated animate__fadeIn" style="display:none;">
        <div class="row">
            <div class="col-md-4"><div class="stat-card"><h5 class="fw-bold">Add Staff</h5><input type="email" id="stfEmail" class="form-control mb-2" placeholder="Email"><input type="text" id="stfPass" class="form-control mb-2" placeholder="Password"><select id="stfRole" class="form-select mb-2"><option value="scanner">Scanner</option><option value="admin">Admin</option></select><button onclick="addStaff()" class="btn btn-dark w-100 fw-bold">Create Account</button></div></div>
            <div class="col-md-8"><div class="stat-card"><table class="table align-middle"><tbody id="staffTable"></tbody></table></div></div>
        </div>
    </div>

    <div id="sec-reports" class="section animate__animated animate__fadeIn" style="display:none;">
        <div class="stat-card">
            <h5 class="fw-bold mb-3">System Reports</h5>
            <p class="text-muted">Generate full activity reports in PDF format.</p>
            <button onclick="exportLogsPDF()" class="btn btn-danger btn-lg"><i class="bi bi-file-earmark-pdf-fill me-2"></i> Download Full Log Report</button>
            <hr>
            <h6 class="fw-bold mt-4">Report Preview (Full History)</h6>
            <div class="table-responsive" style="max-height:400px"><table class="table table-sm table-bordered"><thead><tr><th>Time</th><th>Scout</th><th>Event</th><th>Action</th></tr></thead><tbody id="reportsPreviewTable"></tbody></table></div>
        </div>
    </div>

    <div id="sec-settings" class="section animate__animated animate__fadeIn" style="display:none;">
        <div class="stat-card border-danger border-start border-5"><h3 class="fw-bold text-danger mb-3">Danger Zone</h3><button onclick="initiateSystemReset()" class="btn btn-danger fw-bold">RESET SYSTEM DATABASE</button></div>
    </div>

    <div class="footer">ScoutPass V25 | Full Admin Console</div>
</div>

<div class="offcanvas offcanvas-end" tabindex="-1" id="scoutOffcanvas" style="width: 400px;">
    <div class="offcanvas-header bg-light"><h5 class="offcanvas-title fw-bold">Scout Profile</h5><button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button></div>
    <div class="offcanvas-body p-0">
        <div class="scout-profile-header"><div class="profile-avatar"><i class="bi bi-person-fill"></i></div><h4 class="fw-bold mb-0" id="panelName">Loading...</h4><div class="badge bg-white text-primary mt-2 fs-6" id="panelID">ID: ---</div></div>
        <div class="p-4">
            <div class="row text-center mb-4"><div class="col-6 border-end"><h2 class="fw-bold text-warning mb-0" id="panelPoints">0</h2><small class="text-muted fw-bold">POINTS</small></div><div class="col-6"><h5 class="fw-bold mb-0" id="panelTroop">-</h5><small class="text-muted fw-bold">TROOP</small></div></div>
            <div class="d-grid gap-2 mb-4">
                <button id="btnToggleMissing" class="btn btn-outline-danger" onclick="toggleMissingFromPanel()">Mark as Missing</button>
                <button onclick="downloadSingleID()" class="btn btn-dark">Download ID Card</button>
                <button onclick="deleteScoutFromPanel()" class="btn btn-outline-danger">Delete Profile</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signOut, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, onValue, set, push, serverTimestamp, get, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = { apiKey: "AIzaSyCIrXtwckl-4RPOXDn5IOMiHFh_uXdPiKQ", authDomain: "scoutpass-276cb.firebaseapp.com", projectId: "scoutpass-276cb", databaseURL: "https://scoutpass-276cb-default-rtdb.asia-southeast1.firebasedatabase.app/" };
    const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getDatabase(app); const secondaryApp = initializeApp(firebaseConfig, "Secondary"); const secondaryAuth = getAuth(secondaryApp);

    setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString(); }, 1000);

    let allScouts=[], allLogs=[], allEvents=[], lastBatchScouts=[]; let isScannerLocked = false; let selectedScoutData = null;
    onAuthStateChanged(auth, (user) => { if (!user) window.location.href = "index.html"; else { set(ref(db, `presence/${user.uid}`), { email: user.email, online: true }); } });

    const systemRef = ref(db, 'system_settings/scanning_active');
    onValue(systemRef, (snapshot) => { const isActive = snapshot.val(); isScannerLocked = !isActive; const btn = document.getElementById("globalLockBtn"); if (isActive) { btn.className = "btn-system-lock sys-unlocked"; btn.innerHTML = '<i class="bi bi-unlock-fill"></i> Scanners Active'; } else { btn.className = "btn-system-lock sys-locked"; btn.innerHTML = '<i class="bi bi-lock-fill"></i> SCANNERS LOCKED'; } });
    window.toggleScannerLock = () => set(systemRef, isScannerLocked);

    onValue(ref(db, 'alerts'), (snap) => { const tbody = document.getElementById('alertsTableBody'); const badge = document.getElementById('alertBadge'); tbody.innerHTML = ""; if (snap.exists()) { const alerts = Object.entries(snap.val()); badge.innerText = alerts.length; badge.style.display = 'inline-block'; alerts.reverse().forEach(([key, alert]) => { tbody.innerHTML += `<tr><td class="fw-bold text-danger">${new Date(alert.timestamp).toLocaleTimeString()}</td><td><strong class="text-danger">MISSING FOUND!</strong><br>${alert.scoutName}</td><td>${alert.location}</td><td><button class="btn btn-sm btn-dark" onclick="resolveAlert('${key}')">Mark Safe</button></td></tr>`; }); Swal.fire({toast:true, position:'top-end', icon:'warning', title:'⚠️ Alert Triggered!'}); } else { badge.style.display = 'none'; tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted py-4">No active alerts.</td></tr>`; } });
    window.resolveAlert = (key) => remove(ref(db, `alerts/${key}`)); window.clearAlerts = () => remove(ref(db, 'alerts'));

    window.updatePasteCount = function() { document.getElementById('pasteCount').innerText = document.getElementById('bulkText').value.split('\n').filter(line => line.trim() !== '').length; };
    window.processBulkSafely = async function() { const dist = document.getElementById('regDistrict').value.trim(); const prefix = document.getElementById('regPrefix').value.trim(); const troopNum = document.getElementById('regTroopNum').value.trim(); const troopName = document.getElementById('regTroopName').value.trim(); const text = document.getElementById('bulkText').value; if(!troopNum || !troopName || !text.trim()) return Swal.fire('Error', 'Missing Data!', 'error'); const lines = text.trim().split('\n').filter(l => l.trim() !== ''); document.getElementById('bulkProgress').style.display = 'flex'; lastBatchScouts = []; let successCount = 0; try { const counterRef = ref(db, 'system/scoutCounter'); const snap = await get(counterRef); let idCounter = snap.exists() ? snap.val() + 1 : 1; const updates = {}; lines.forEach(line => { const name = line.trim(); if(name) { const seq = String(idCounter).padStart(3, '0'); const displayID = `${prefix}${troopNum}/${seq}`; const safeKey = `${prefix}${troopNum}_${seq}`; const scoutObj = { id: displayID, name: name, troop: `${troopNum} - ${troopName}`, district: dist, points: 0, isMissing: false, regDate: serverTimestamp() }; updates[`scouts/${safeKey}`] = scoutObj; lastBatchScouts.push(scoutObj); idCounter++; successCount++; } }); if (Object.keys(updates).length > 0) { await update(ref(db), updates); await set(ref(db, 'system/scoutCounter'), idCounter - 1); } document.getElementById('bulkProgress').querySelector('.progress-bar').style.width = '100%'; updateRecentTable(lastBatchScouts); document.getElementById('bulkText').value = ''; Swal.fire({ icon: 'success', title: 'Done', text: `Registered ${successCount} scouts.` }); downloadBatchPDF(lastBatchScouts, `IDs_${troopName}`); } catch(e) { Swal.fire('Error', e.message, 'error'); } finally { setTimeout(() => { document.getElementById('bulkProgress').style.display = 'none'; }, 2000); } };
    
    window.addStaff = async () => { const e=document.getElementById('stfEmail').value, p=document.getElementById('stfPass').value, r=document.getElementById('stfRole').value; if(e&&p) { try { const c = await createUserWithEmailAndPassword(secondaryAuth, e, p); await set(ref(db, `users/${c.user.uid}`), { email:e, role:r }); Swal.fire('Success', 'Staff Account Created', 'success'); } catch(err) { Swal.fire('Error', err.message, 'error'); } } };
    onValue(ref(db, 'users'), (s) => { const tbody = document.getElementById('staffTable'); tbody.innerHTML = ""; if (s.exists()) { Object.entries(s.val()).forEach(([uid, u]) => { tbody.innerHTML += `<tr><td>${u.email}</td><td><span class="badge bg-dark">${u.role}</span></td><td><button class="btn btn-sm btn-outline-danger" onclick="removeUser('${uid}')"><i class="bi bi-trash"></i></button></td></tr>`; }); } });
    window.removeUser = (uid) => remove(ref(db, `users/${uid}`));
    window.createSpecialQR = async function() { const name = document.getElementById('spName').value; const points = document.getElementById('spPoints').value; if(!name || !points) return; const newRef = push(ref(db, 'special_codes')); await set(newRef, { name: name, points: parseInt(points), isUsed: false, createdAt: serverTimestamp() }); const { jsPDF } = window.jspdf; const doc = new jsPDF({ format: [80, 80] }); const qrDiv = document.getElementById('qr-hidden'); qrDiv.innerHTML=""; new QRCode(qrDiv, { text: `BONUS:${newRef.key}`, width: 150, height: 150 }); const img = qrDiv.querySelector('canvas').toDataURL("image/png"); doc.setFontSize(12); doc.text("BONUS TOKEN", 40, 10, {align:'center'}); doc.addImage(img, 'PNG', 15, 15, 50, 50); doc.setFontSize(10); doc.text(name, 40, 70, {align:'center'}); doc.text(`${points} PTS`, 40, 75, {align:'center'}); doc.save(`${name}_Bonus.pdf`); };
    onValue(ref(db, 'special_codes'), (s) => { let h = '<ul class="list-group">'; if(s.exists()) { Object.entries(s.val()).forEach(([k, v]) => { h += `<li class="list-group-item d-flex justify-content-between"><div><strong>${v.name}</strong> (${v.points} pts)</div><button onclick="removeSpecial('${k}')" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></button></li>`; }); } document.getElementById('specialList').innerHTML = h + '</ul>'; });
    window.removeSpecial = (k) => remove(ref(db, `special_codes/${k}`));

    onValue(ref(db, 'scouts'), (s) => { allScouts = s.exists() ? Object.values(s.val()) : []; document.getElementById('statTotal').innerText = allScouts.length; let h = ''; allScouts.reverse().slice(0,100).forEach(sc => { const safeKey = sc.id.replace('/', '_'); const status = sc.isMissing ? '<span class="badge bg-danger">MISSING</span>' : '<span class="badge bg-success">Active</span>'; h += `<tr style="cursor:pointer" onclick="viewScout('${safeKey}')"><td>${sc.id}</td><td class="fw-bold text-primary">${sc.name}</td><td>${sc.troop}</td><td>${sc.points||0}</td><td>${status}</td></tr>`; }); document.getElementById('dirTable').innerHTML = h; });
    
    // UPDATED EVENTS JS
    window.updateButtonPlaceholder = () => { const t = document.getElementById('evtType').value; const b = document.getElementById('evtButtons'); if(t === 'ACCESS') b.value = "IN,OUT"; else if(t === 'ONETIME') b.value = "SCAN"; else b.value = ""; }
    window.addEvent = async () => { const n=document.getElementById('evtName').value, p=document.getElementById('evtPoints').value, t=document.getElementById('evtType').value, b=document.getElementById('evtButtons').value; const bArray = b ? b.split(',').map(s=>s.trim()) : ['SCAN']; if(n) { await push(ref(db, 'events'), {name:n, points:p, type:t, buttons:bArray, active:true}); Swal.fire({icon:'success', title:'Event Created', timer:1500, showConfirmButton:false}); document.getElementById('evtName').value = ''; } }
    
    // LOGS FOR BOTH TABS
    onValue(ref(db, 'logs'), (s) => { 
        allLogs = s.exists() ? Object.values(s.val()) : []; 
        document.getElementById('statScans').innerText = allLogs.length; 
        
        let inside = 0; 
        allLogs.forEach(l => { if(l.type === 'ACCESS') { if(l.action==='IN') inside++; else if(l.action==='OUT') inside--; }}); 
        document.getElementById('statInside').innerText = Math.max(0, inside); 
        
        // 1. Live Logs Table (New)
        let liveH = ''; 
        allLogs.slice().reverse().slice(0,100).forEach(l => { 
            const staff = l.scannedBy ? l.scannedBy.split('@')[0] : 'System';
            liveH += `<tr><td>${new Date(l.timestamp).toLocaleTimeString()}</td><td class="fw-bold text-primary">${l.scoutName}</td><td>${l.eventName}</td><td><span class="badge bg-dark">${l.action}</span></td><td class="text-muted small">${staff}</td></tr>`; 
        }); 
        document.getElementById('liveLogsBody').innerHTML = liveH; 

        // 2. Reports Preview Table
        let reportH = '';
        allLogs.slice().reverse().slice(0,50).forEach(l => { 
            reportH += `<tr><td>${new Date(l.timestamp).toLocaleTimeString()}</td><td>${l.scoutName}</td><td>${l.eventName}</td><td>${l.action}</td></tr>`; 
        });
        document.getElementById('reportsPreviewTable').innerHTML = reportH;

        renderEventCards(); 
    });

    onValue(ref(db, 'events'), (s) => { const data = s.val(); allEvents = data ? Object.entries(data).map(([key, val]) => ({key, ...val})) : []; let h = ''; allEvents.forEach(e => { const btns = e.buttons ? e.buttons.map(b=>`<span class="badge bg-light text-dark border ms-1">${b}</span>`).join('') : ''; h += `<div class="d-flex justify-content-between align-items-center border-bottom p-2"><div><span class="fw-bold text-primary">${e.name}</span><div class="small text-muted mt-1">Buttons:${btns}</div></div><button onclick="removeEvent('${e.key}')" class="btn btn-sm text-danger"><i class="bi bi-trash"></i></button></div>`; }); document.getElementById('eventsList').innerHTML = h; renderEventCards(); });
    onValue(ref(db, 'presence'), (snap) => { document.getElementById('statOnline').innerText = snap.exists() ? Object.keys(snap.val()).length : 0; });

    function renderEventCards() { const container = document.getElementById('liveEventCards'); container.innerHTML = ""; if(allEvents.length === 0) { container.innerHTML = `<div class="col-12 text-center py-5">No Events created.</div>`; return; } allEvents.forEach(evt => { let inCount = 0, outCount = 0; allLogs.forEach(l => { if(l.eventName === evt.name) { if(l.action === 'IN') inCount++; if(l.action === 'OUT') outCount++; } }); let body = evt.type === 'ACCESS' ? `<div class="row text-center"><div class="col-4 border-end"><h3>${inCount}</h3><small>IN</small></div><div class="col-4 border-end"><h3>${outCount}</h3><small>OUT</small></div><div class="col-4"><h3 class="text-primary">${Math.max(0,inCount-outCount)}</h3><small>INSIDE</small></div></div>` : `<div class="text-center"><h2 class="text-success">${inCount}</h2><small>COMPLETED</small></div>`; container.innerHTML += `<div class="col-md-4"><div class="stat-card border-top border-4 border-primary"><h5 class="fw-bold">${evt.name}</h5><hr>${body}</div></div>`; }); }
    function updateRecentTable(list) { let h=''; list.slice().reverse().forEach(s=>{ h+=`<tr><td>${s.id}</td><td>${s.name}</td></tr>`}); document.getElementById('regTable').innerHTML=h; }
    window.downloadBatchPDF = function(scoutList, filename) { if(!scoutList || scoutList.length === 0) return; const { jsPDF } = window.jspdf; const doc = new jsPDF(); const cardW = 45, cardH = 65, marginX = 15, marginY = 15, gap = 2; let col = 0, row = 0; const qrDiv = document.getElementById('qr-hidden'); scoutList.forEach((s, i) => { if(i > 0 && i % 16 === 0) { doc.addPage(); col = 0; row = 0; } qrDiv.innerHTML = ""; new QRCode(qrDiv, { text: s.id, width: 100, height: 100 }); const img = qrDiv.querySelector('canvas').toDataURL("image/png"); const curX = marginX + (col * (cardW + gap)); const curY = marginY + (row * (cardH + gap)); doc.setLineWidth(0.1); doc.rect(curX, curY, cardW, cardH); doc.setFontSize(10); doc.setFont("helvetica", "bold"); doc.text("SCOUT PASS", curX + (cardW/2), curY + 8, {align:'center'}); doc.addImage(img, 'PNG', curX + (cardW - 25)/2, curY + 12, 25, 25); doc.setFontSize(11); doc.text(s.id, curX + (cardW/2), curY + 44, {align:'center'}); doc.setFont("helvetica", "normal"); doc.setFontSize(8); doc.text(s.name.substring(0,18), curX + (cardW/2), curY + 52, {align:'center'}); doc.setFontSize(6); doc.setTextColor(100); doc.text(s.troop.substring(0,28), curX + (cardW/2), curY + 58, {align:'center'}); doc.setTextColor(0); col++; if(col >= 4) { col = 0; row++; } }); doc.save(filename ? `${filename}.pdf` : `Scout_IDs.pdf`); }
    window.showSection = (id) => { document.querySelectorAll('.section').forEach(d=>d.style.display='none'); document.getElementById('sec-'+id).style.display='block'; document.getElementById('pageTitle').innerText = id.toUpperCase(); };
    window.logout = () => signOut(auth).then(()=>window.location.href="index.html"); window.filterDirectory = () => { const term = document.getElementById('searchDir').value.toLowerCase(); document.querySelectorAll('#dirTable tr').forEach(row => { row.style.display = row.innerText.toLowerCase().includes(term) ? '' : 'none'; }); };
    window.removeEvent = (k) => remove(ref(db, `events/${k}`)); window.initiateSystemReset = async () => { const { value: code } = await Swal.fire({ title: '⚠️ SYSTEM RESET', input: 'password', text: 'Enter Admin Code to WIPE database.', confirmButtonColor: '#d33' }); if (code === 'MadhawaBasnayake@200431504082#') { await remove(ref(db, 'scouts')); await remove(ref(db, 'logs')); await remove(ref(db, 'events')); await remove(ref(db, 'alerts')); await set(ref(db, 'system/scoutCounter'), 0); Swal.fire('WIPED', 'System Reset Complete', 'success'); } };
    
    // RESTORED: MISSING FUNCTIONALITY
    window.viewScout = (safeKey) => { const sc = allScouts.find(s => s.id.replace('/','_') === safeKey); if(sc) { document.getElementById('panelName').innerText = sc.name; document.getElementById('panelID').innerText = sc.id; document.getElementById('panelPoints').innerText = sc.points; document.getElementById('panelTroop').innerText = sc.troop; selectedScoutData = sc; const btn = document.getElementById('btnToggleMissing'); if(sc.isMissing) { btn.className = "btn btn-success"; btn.innerText = "Mark as Safe"; } else { btn.className = "btn btn-outline-danger"; btn.innerText = "Mark as Missing"; } new bootstrap.Offcanvas(document.getElementById('scoutOffcanvas')).show(); } };
    window.toggleMissingFromPanel = async () => { if(!selectedScoutData) return; const safeKey = selectedScoutData.id.replace('/','_'); const newState = !selectedScoutData.isMissing; await update(ref(db, `scouts/${safeKey}`), { isMissing: newState }); if(newState) { push(ref(db, 'alerts'), { scoutName: selectedScoutData.name, location: "Admin Panel Report", timestamp: serverTimestamp() }); Swal.fire({icon: 'warning', title: 'Marked Missing', text: 'Alert Sent!'}); } else { Swal.fire({icon: 'success', title: 'Marked Safe'}); } viewScout(safeKey); };
    
    window.downloadSingleID = () => downloadBatchPDF([selectedScoutData], `${selectedScoutData.id.replace('/','_')}`); window.deleteScoutFromPanel = async () => { if(!selectedScoutData) return; await remove(ref(db, `scouts/${selectedScoutData.id.replace('/','_')}`)); bootstrap.Offcanvas.getInstance(document.getElementById('scoutOffcanvas')).hide(); }; window.exportLogsPDF = () => { const { jsPDF } = window.jspdf; const doc = new jsPDF(); doc.autoTable({ head: [['Time', 'Scout', 'Event', 'Action']], body: allLogs.map(l => [new Date(l.timestamp).toLocaleTimeString(), l.scoutName, l.eventName, l.action]) }); doc.save(`Logs.pdf`); }
</script>
</body>
</html>
