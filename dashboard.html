<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scout Pass | Command Center V33.6 (Safe Delete)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* DEFAULT (LIGHT) */
        :root { --primary: #3B82F6; --bg: #f5f6fa; --card: #ffffff; --text: #2d3436; --border: #dfe6e9; --input-bg: #f8f9fa; --gold: #FFD700; --silver: #C0C0C0; --bronze: #CD7F32; }
        /* DEEP BLACK THEME */
        [data-theme="dark"] { --bg: #000000; --card: #0F0F0F; --text: #ffffff; --border: #333333; --input-bg: #1a1a1a; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Outfit', sans-serif; transition: 0.3s; }
        [data-theme="dark"] .text-muted { color: #d1d5db !important; }
        [data-theme="dark"] .stat-card h6 { color: #ffffff !important; opacity: 1 !important; text-transform: uppercase; letter-spacing: 1px; }
        .sidebar { position: fixed; height: 100vh; width: 260px; background: var(--card); padding: 20px; z-index: 100; border-right: 1px solid var(--border); transition: 0.3s; }
        .main-content { margin-left: 260px; padding: 30px; min-height: 100vh; display: flex; flex-direction: column; }
        .stat-card { background: var(--card); border-radius: 20px; padding: 25px; border: 1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.03); margin-bottom: 20px; transition: 0.3s; }
        .nav-link { color: #888; padding: 12px 20px; border-radius: 12px; margin-bottom: 5px; cursor: pointer; transition: 0.2s; }
        .nav-link:hover, .nav-link.active { background: rgba(59, 130, 246, 0.15); color: var(--primary); font-weight: 600; transform: translateX(5px); }
        .form-control, .form-select { background: var(--input-bg); border: 1px solid var(--border); color: var(--text); padding: 12px; border-radius: 10px; }
        .form-control:focus, .form-select:focus { background: var(--input-bg); color: var(--text); border-color: var(--primary); box-shadow: none; }
        .table { color: var(--text); --bs-table-bg: transparent; }
        .table-hover tbody tr:hover { color: var(--text); background-color: rgba(59, 130, 246, 0.1); }
        [data-theme="dark"] .table-light { background-color: #1a1a1a; color: #fff; }
        [data-theme="dark"] .table-light th { background-color: #1a1a1a; color: #fff; border-color: #333; }
        .btn-system-lock { padding: 10px 20px; border-radius: 50px; font-weight: 700; border: none; transition: 0.3s; }
        .sys-unlocked { background-color: #10B981; color: white; }
        .sys-locked { background-color: #EF4444; color: white; animation: pulseRed 2s infinite; }
        .theme-toggle { cursor: pointer; font-size: 1.5rem; padding: 5px 10px; border-radius: 50%; transition: 0.3s; }
        .rank-badge { width: 35px; height: 35px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; color: #000; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        #qr-hidden { display: none; }
        .scout-profile-header { background: linear-gradient(135deg, #3B82F6, #2563EB); color: white; padding: 30px; border-radius: 20px 20px 0 0; text-align: center; }
        .profile-avatar { width: 80px; height: 80px; background: white; color: var(--primary); border-radius: 50%; font-size: 35px; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; border: 4px solid rgba(255,255,255,0.3); }
        .footer { margin-top: auto; padding-top: 30px; text-align: center; color: #555; font-size: 0.8rem; font-weight: 500; }
        @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } }
        .common-data-box { background: rgba(59, 130, 246, 0.1); border: 1px solid var(--primary); padding: 15px; border-radius: 15px; margin-bottom: 20px; }
        .admin-only, .mod-allowed { display: block; }
    </style>
</head>
<body>

<div id="qr-hidden"></div>
<input type="file" id="importFile" style="display:none" onchange="importData(this)" accept=".json">

<div class="sidebar">
    <div class="brand mb-4 text-primary fw-bold fs-4"><i class="bi bi-shield-lock-fill"></i> ScoutPass</div>
    <div class="nav flex-column">
        <div class="nav-link active" onclick="showSection('overview')"><i class="bi bi-grid-1x2-fill me-2"></i> War Room</div>
        <div class="nav-link text-danger fw-bold" onclick="showSection('alerts')"><i class="bi bi-bell-fill me-2"></i> Alerts <span id="alertBadge" class="badge bg-danger ms-2" style="display:none">0</span></div>
        <div class="nav-link" onclick="showSection('livelogs')"><i class="bi bi-activity me-2"></i> Live Logs</div>
        <div class="nav-link" onclick="showSection('rankings')"><i class="bi bi-trophy-fill me-2"></i> Rankings</div>
        <div class="nav-link" onclick="showSection('registration')"><i class="bi bi-person-plus-fill me-2"></i> Registration</div>
        <div class="nav-link" onclick="showSection('directory')"><i class="bi bi-search me-2"></i> Directory</div>
        <div class="nav-link" onclick="showSection('events')"><i class="bi bi-calendar-event-fill me-2"></i> Events</div>
        <div class="nav-link" onclick="showSection('special')"><i class="bi bi-ticket-perforated-fill me-2"></i> Special QR</div>
        <div class="nav-link admin-only" onclick="showSection('staff')"><i class="bi bi-people-fill me-2"></i> Staff Manager</div>
        <div class="nav-link" onclick="showSection('reports')"><i class="bi bi-file-earmark-pdf-fill me-2"></i> Reports</div>
        <div class="nav-link mt-3 text-dark fw-bold admin-only" onclick="showSection('settings')"><i class="bi bi-gear-fill me-2"></i> Settings</div>
        <div class="nav-link mt-4 text-danger" onclick="logout()"><i class="bi bi-box-arrow-left me-2"></i> Logout</div>
    </div>
</div>

<div class="main-content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold mb-0" id="pageTitle">WAR ROOM</h2>
            <small class="text-muted">System Online • <span id="clock">Loading...</span> • <span id="roleDisplay" class="badge bg-secondary">...</span></small>
        </div>
        <div class="d-flex gap-3 align-items-center">
            <i class="bi bi-moon-stars-fill theme-toggle" onclick="toggleTheme()" id="themeIcon"></i>
            <button id="globalLockBtn" class="btn-system-lock sys-unlocked admin-only" onclick="toggleScannerLock()">
                <i class="bi bi-unlock-fill"></i> Scanners Active
            </button>
        </div>
    </div>

    <div id="sec-overview" class="section animate__animated animate__fadeIn">
        <div class="row g-4">
            <div class="col-md-3"><div class="stat-card"><h6 class="text-muted fw-bold small">TOTAL REGISTERED</h6><h2 class="fw-bold mb-0" id="statTotal">0</h2></div></div>
            <div class="col-md-3"><div class="stat-card"><h6 class="text-muted fw-bold small">TOTAL SCANS</h6><h2 class="fw-bold mb-0" id="statScans">0</h2></div></div>
            <div class="col-md-3"><div class="stat-card border border-success"><h6 class="text-success fw-bold small">ONLINE STAFF</h6><h2 class="fw-bold mb-0 text-success" id="statOnline">0</h2></div></div>
            <div class="col-md-3"><div class="stat-card border border-primary"><h6 class="text-primary fw-bold small">INSIDE (MAIN GATE)</h6><h2 class="fw-bold mb-0 text-primary" id="statInside">0</h2></div></div>
        </div>
        <h5 class="fw-bold mt-4 mb-3">Live Event Dashboard</h5>
        <div id="liveEventCards" class="row g-4"><div class="col-12 text-center text-muted py-5">Loading events...</div></div>
    </div>

    <div id="sec-alerts" class="section animate__animated animate__fadeIn" style="display:none;">
        <div class="stat-card border-danger border-top border-5">
            <div class="d-flex justify-content-between mb-4"><h5 class="fw-bold text-danger">Critical Alerts</h5><button onclick="clearAlerts()" class="btn btn-sm btn-outline-secondary admin-only">Clear All</button></div>
            <div class="table-responsive"><table class="table align-middle"><tbody id="alertsTableBody"><tr><td colspan="4" class="text-center text-muted py-4">No active alerts.</td></tr></tbody></table></div>
        </div>
    </div>

    <div id="sec-livelogs" class="section animate__animated animate__fadeIn" style="display:none;">
        <div class="stat-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-bold text-primary"><i class="bi bi-activity"></i> Real-time Activity Feed</h5>
                <span class="badge bg-success animate__animated animate__pulse animate__infinite">LIVE</span>
            </div>
            <div class="table-responsive" style="max-height: 600px;">
                <table class="table table-hover align-middle">
                    <thead class="table-light" style="position: sticky; top: 0;">
                        <tr><th>Time</th><th>Scout Name</th><th>Event</th><th>Action</th><th>Scanned By</th></tr>
                    </thead>
                    <tbody id="liveLogsBody"><tr><td colspan="5" class="text-center text-muted">Waiting...</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="sec-rankings" class="section animate__animated animate__fadeIn" style="display:none;">
        <div class="stat-card border-warning border-top border-5">
            <h4 class="fw-bold mb-4 text-warning"><i class="bi bi-trophy-fill"></i> Top 10 High Performers (Auto-Calculated)</h4>
            <div class="table-responsive">
                <table class="table align-middle">
                    <thead class="table-light"><tr><th>Rank</th><th>Scout Name</th><th>Troop</th><th>Total Points</th></tr></thead>
                    <tbody id="rankingsBody"><tr><td colspan="4" class="text-center">Calculating points from logs...</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="sec-registration" class="section animate__animated animate__fadeIn" style="display:none;">
        <div class="stat-card admin-only">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="fw-bold mb-0"><i class="bi bi-person-vcard-fill text-primary"></i> Direct Registration</h4>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-success btn-sm" onclick="exportData()"><i class="bi bi-download"></i> Export DB</button>
                    <button class="btn btn-outline-warning btn-sm" onclick="document.getElementById('importFile').click()"><i class="bi bi-upload"></i> Import DB</button>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="common-data-box">
                        <h6 class="fw-bold text-primary mb-2">Input Format (CSV)</h6>
                        <p class="small text-muted mb-0">Enter one student per line: <br><code class="fw-bold text-dark">RegistrationNo, Name</code></p>
                        <p class="small text-muted">Example: <code>KG15/001, Kamal Perera</code></p>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2"><h6 class="fw-bold">Paste List Here</h6><span class="badge bg-dark">Count: <span id="pasteCount" class="text-warning">0</span></span></div>
                    <textarea id="bulkText" class="form-control mb-3" rows="10" placeholder="KG15/001, Kamal Perera&#10;KG15/002, Nimal Silva" oninput="updatePasteCount()"></textarea>
                    <div class="progress mb-3" style="display:none" id="bulkProgress"><div class="progress-bar bg-success" style="width: 0%"></div></div>
                    <button class="btn btn-primary w-100 fw-bold py-3" onclick="processBulkSafely()">PROCESS & DOWNLOAD IDs</button>
                </div>
                <div class="col-md-6"><h6 class="fw-bold mb-2">Recently Added</h6><div style="max-height: 350px; overflow-y: auto; border:1px solid #333; border-radius:10px;"><table class="table table-sm table-striped mb-0"><thead class="table-dark" style="position: sticky; top: 0;"><tr><th>Reg No</th><th>Name</th></tr></thead><tbody id="regTable"></tbody></table></div></div>
            </div>
        </div>
        <div class="stat-card read-only-msg" style="display:none; text-align:center; padding:50px;"><i class="bi bi-eye-slash-fill fs-1 text-muted"></i><h4 class="mt-3 text-muted">View Only Mode</h4></div>
    </div>

    <div id="sec-directory" class="section animate__animated animate__fadeIn" style="display:none;">
        <div class="stat-card">
            <input type="text" id="searchDir" class="form-control" placeholder="Search ID or Name..." onkeyup="filterDirectory()">
            <div class="table-responsive mt-3"><table class="table align-middle table-hover"><thead><tr><th>ID</th><th>Name</th><th>Troop</th><th>Points</th><th>Status</th></tr></thead><tbody id="dirTable"></tbody></table></div>
        </div>
    </div>

    <div id="sec-events" class="section animate__animated animate__fadeIn" style="display:none;">
        <div class="row">
            <div class="col-md-4 mod-allowed">
                <div class="stat-card">
                    <h5 class="fw-bold">Add Event</h5>
                    <label class="small fw-bold text-muted">Event Type</label>
                    <select id="evtType" class="form-select mb-2" onchange="updateButtonPlaceholder()"><option value="ACCESS">Entrance (IN/OUT)</option><option value="ONETIME">Activity (One-Time)</option><option value="CUSTOM">Custom Buttons</option></select>
                    
                    <label class="small fw-bold text-muted">Event Name</label>
                    <input type="text" id="evtName" class="form-control mb-2" placeholder="Ex: Main Gate">
                    
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="evtOneTime">
                        <label class="form-check-label small fw-bold text-muted" for="evtOneTime">One-Time Only (1 Per Scout)</label>
                    </div>

                    <label class="small fw-bold text-muted">Action Buttons</label>
                    <input type="text" id="evtButtons" class="form-control mb-2" value="IN,OUT" placeholder="Ex: IN, OUT">
                    <label class="small fw-bold text-muted">Points</label>
                    <input type="number" id="evtPoints" class="form-control mb-2" placeholder="0">
                    <button onclick="addEvent()" class="btn btn-success w-100 fw-bold mt-2">Create Event</button>
                </div>
            </div>
            <div class="col-md-8"><div class="stat-card"><h6 class="fw-bold mb-3">Active Events</h6><div id="eventsList"></div></div></div>
        </div>
    </div>

    <div id="sec-special" class="section animate__animated animate__fadeIn" style="display:none;">
        <div class="row">
            <div class="col-md-5 admin-only">
                <div class="stat-card">
                    <h5 class="fw-bold mb-3">Bonus Token</h5>
                    <input type="text" id="spName" class="form-control mb-2" placeholder="Token Name">
                    <input type="number" id="spPoints" class="form-control mb-2" placeholder="Points">
                    <select id="spType" class="form-select mb-3"><option value="unlimited">Unlimited Use</option><option value="onetime">One-Time Use</option></select>
                    <button onclick="createSpecialQR()" class="btn btn-warning w-100 fw-bold">Generate QR</button>
                </div>
            </div>
            <div class="col-md-7"><div class="stat-card"><h6 class="fw-bold">Active Tokens</h6><div id="specialList"></div></div></div>
        </div>
    </div>

    <div id="sec-staff" class="section animate__animated animate__fadeIn" style="display:none;">
        <div class="row">
            <div class="col-md-4 admin-only">
                <div class="stat-card">
                    <h5 class="fw-bold">Add Staff</h5>
                    <input type="email" id="stfEmail" class="form-control mb-2" placeholder="Email">
                    <input type="text" id="stfPass" class="form-control mb-2" placeholder="Password">
                    <select id="stfRole" class="form-select mb-2"><option value="scanner">Scanner (App Only)</option><option value="viewer">Viewer (Read Only)</option><option value="moderator">Moderator (View + Add Event)</option><option value="admin">Admin (Full Access)</option></select>
                    <button onclick="addStaff()" class="btn btn-dark w-100 fw-bold">Create Account</button>
                </div>
            </div>
            <div class="col-md-8"><div class="stat-card"><table class="table align-middle"><tbody id="staffTable"></tbody></table></div></div>
        </div>
    </div>

    <div id="sec-reports" class="section animate__animated animate__fadeIn" style="display:none;">
        <div class="stat-card">
            <h5 class="fw-bold mb-3">System Reports</h5>
            <div class="row g-2 mb-3 align-items-end">
                <div class="col-md-5"><select id="reportEventFilter" class="form-select" onchange="filterReports()"><option value="ALL">All Events</option></select></div>
                <div class="col-md-3"><button onclick="downloadEventReport()" class="btn btn-primary w-100 fw-bold admin-only"><i class="bi bi-file-earmark-arrow-down-fill"></i> Download Filtered</button></div>
                <div class="col-md-4 text-end"><button onclick="exportLogsPDF()" class="btn btn-outline-danger admin-only"><i class="bi bi-file-earmark-pdf-fill"></i> Full Log Dump</button></div>
            </div>
            <hr>
            <h6 class="fw-bold mt-4">Report Preview <span id="previewCount" class="badge bg-secondary ms-2">0</span></h6>
            <div class="table-responsive" style="max-height:400px"><table class="table table-sm table-bordered"><thead><tr><th>Time</th><th>Scout</th><th>Event</th><th>Action</th></tr></thead><tbody id="reportsPreviewTable"></tbody></table></div>
        </div>
    </div>

    <div id="sec-settings" class="section animate__animated animate__fadeIn" style="display:none;">
        <div class="stat-card border-danger border-start border-5"><h3 class="fw-bold text-danger mb-3">Danger Zone</h3><button onclick="initiateSystemReset()" class="btn btn-danger fw-bold">RESET SYSTEM DATABASE</button></div>
    </div>

    <div class="footer">ScoutPass | Developed by Madhawa Basanayake</div>
</div>

<div class="offcanvas offcanvas-end" tabindex="-1" id="scoutOffcanvas" style="width: 400px;">
    <div class="offcanvas-header bg-light"><h5 class="offcanvas-title fw-bold">Scout Profile</h5><button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button></div>
    <div class="offcanvas-body p-0">
        <div class="scout-profile-header"><div class="profile-avatar"><i class="bi bi-person-fill"></i></div><h4 class="fw-bold mb-0" id="panelName">Loading...</h4><div class="badge bg-white text-primary mt-2 fs-6" id="panelID">ID: ---</div></div>
        <div class="p-4">
            <div class="row text-center mb-4"><div class="col-6 border-end"><h2 class="fw-bold text-warning mb-0" id="panelPoints">0</h2><small class="text-muted fw-bold">POINTS</small></div><div class="col-6"><h5 class="fw-bold mb-0" id="panelTroop">-</h5><small class="text-muted fw-bold">TROOP</small></div></div>
            <div class="d-grid gap-2 mb-4 admin-only">
                <button id="btnToggleMissing" class="btn btn-outline-danger" onclick="toggleMissingFromPanel()">Mark as Missing</button>
                <button onclick="downloadSingleID()" class="btn btn-dark">Download ID Card</button>
                <button onclick="deleteScoutFromPanel()" class="btn btn-outline-danger">Delete Profile</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signOut, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, onValue, set, push, serverTimestamp, get, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = { apiKey: "AIzaSyCIrXtwckl-4RPOXDn5IOMiHFh_uXdPiKQ", authDomain: "scoutpass-276cb.firebaseapp.com", projectId: "scoutpass-276cb", databaseURL: "https://scoutpass-276cb-default-rtdb.asia-southeast1.firebasedatabase.app/" };
    const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getDatabase(app); const secondaryApp = initializeApp(firebaseConfig, "Secondary"); const secondaryAuth = getAuth(secondaryApp);

    setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString(); }, 1000);

    let allScouts=[], allLogs=[], allEvents=[], lastBatchScouts=[]; let isScannerLocked = false; let selectedScoutData = null; let currentUserRole = 'admin'; let calculatedScoutPoints = {};

    onAuthStateChanged(auth, async (user) => { 
        if (!user) window.location.href = "index.html"; 
        else { 
            const snap = await get(ref(db, `users/${user.uid}`));
            if(snap.exists()) {
                currentUserRole = snap.val().role || 'admin';
                document.getElementById('roleDisplay').innerText = currentUserRole.toUpperCase();
                if(currentUserRole === 'scanner') { document.body.innerHTML = "<h1 style='text-align:center;margin-top:20%'>Access Denied<br>Use Mobile App</h1>"; return; }
                applyPermissions();
            }
            set(ref(db, `presence/${user.uid}`), { email: user.email, online: true }); 
        } 
    });

    function applyPermissions() {
        const adminEls = document.querySelectorAll('.admin-only'); const modEls = document.querySelectorAll('.mod-allowed'); const readOnlyMsgs = document.querySelectorAll('.read-only-msg');
        if (currentUserRole === 'admin') { adminEls.forEach(el => el.style.display = 'block'); modEls.forEach(el => el.style.display = 'block'); readOnlyMsgs.forEach(el => el.style.display = 'none'); } 
        else if (currentUserRole === 'moderator') { adminEls.forEach(el => el.style.display = 'none'); modEls.forEach(el => el.style.display = 'block'); readOnlyMsgs.forEach(el => el.style.display = 'block'); } 
        else if (currentUserRole === 'viewer') { adminEls.forEach(el => el.style.display = 'none'); modEls.forEach(el => el.style.display = 'none'); readOnlyMsgs.forEach(el => el.style.display = 'block'); }
    }

    window.toggleTheme = () => { const body = document.body; const icon = document.getElementById('themeIcon'); if(body.getAttribute('data-theme') === 'dark') { body.removeAttribute('data-theme'); icon.className = 'bi bi-moon-stars-fill theme-toggle'; localStorage.setItem('theme', 'light'); } else { body.setAttribute('data-theme', 'dark'); icon.className = 'bi bi-sun-fill theme-toggle text-warning'; localStorage.setItem('theme', 'dark'); } }
    if(localStorage.getItem('theme') === 'dark') window.toggleTheme();

    const systemRef = ref(db, 'system_settings/scanning_active');
    onValue(systemRef, (snapshot) => { const isActive = snapshot.val(); isScannerLocked = !isActive; const btn = document.getElementById("globalLockBtn"); if (isActive) { btn.className = "btn-system-lock sys-unlocked admin-only"; btn.innerHTML = '<i class="bi bi-unlock-fill"></i> Scanners Active'; } else { btn.className = "btn-system-lock sys-locked admin-only"; btn.innerHTML = '<i class="bi bi-lock-fill"></i> SCANNERS LOCKED'; } applyPermissions(); });
    window.toggleScannerLock = () => set(systemRef, isScannerLocked);

    onValue(ref(db, 'alerts'), (snap) => { const tbody = document.getElementById('alertsTableBody'); const badge = document.getElementById('alertBadge'); tbody.innerHTML = ""; if (snap.exists()) { const alerts = Object.entries(snap.val()); badge.innerText = alerts.length; badge.style.display = 'inline-block'; alerts.reverse().forEach(([key, alert]) => { tbody.innerHTML += `<tr><td class="fw-bold text-danger">${new Date(alert.timestamp).toLocaleTimeString()}</td><td><strong class="text-danger">MISSING FOUND!</strong><br>${alert.scoutName}</td><td>${alert.location}</td><td><button class="btn btn-sm btn-dark admin-only" onclick="resolveAlert('${key}')">Mark Safe</button></td></tr>`; }); if(currentUserRole!=='viewer') Swal.fire({toast:true, position:'top-end', icon:'warning', title:'⚠️ Alert Triggered!'}); applyPermissions(); } else { badge.style.display = 'none'; tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted py-4">No active alerts.</td></tr>`; } });
    window.resolveAlert = (key) => remove(ref(db, `alerts/${key}`)); window.clearAlerts = () => remove(ref(db, 'alerts'));

    onValue(ref(db, 'logs'), (s) => { 
        allLogs = s.exists() ? Object.values(s.val()) : []; 
        document.getElementById('statScans').innerText = allLogs.length; 
        
        let inside = 0; 
        calculatedScoutPoints = {}; // Reset calculation

        allLogs.forEach(l => { 
            // 1. Inside Count
            if(l.type === 'ACCESS') { if(l.action==='IN') inside++; else if(l.action==='OUT') inside--; }
            
            // 2. Point Calculation (using ALL events, even archived ones)
            let pointsToAdd = 0;
            if (l.eventName && l.eventName.startsWith("BONUS")) {
                const bonusMatch = l.action.match(/(\d+)/);
                if(bonusMatch) pointsToAdd = parseInt(bonusMatch[0]) || 0;
            } else {
                // IMPORTANT: Search in allEvents (which includes archived ones)
                const evt = allEvents.find(e => e.name === l.eventName);
                if (evt && evt.points) {
                    pointsToAdd = parseInt(evt.points) || 0;
                }
            }

            if(pointsToAdd > 0 && l.scoutID) {
                if(!calculatedScoutPoints[l.scoutID]) calculatedScoutPoints[l.scoutID] = 0;
                calculatedScoutPoints[l.scoutID] += pointsToAdd;
            }
        }); 

        document.getElementById('statInside').innerText = Math.max(0, inside); 
        
        let liveH = ''; 
        allLogs.slice().reverse().slice(0,100).forEach(l => { 
            const staff = l.scannedBy ? l.scannedBy.split('@')[0] : 'System';
            liveH += `<tr><td>${new Date(l.timestamp).toLocaleTimeString()}</td><td class="fw-bold text-primary">${l.scoutName}</td><td>${l.eventName}</td><td><span class="badge bg-dark">${l.action}</span></td><td class="text-muted small">${staff}</td></tr>`; 
        }); 
        document.getElementById('liveLogsBody').innerHTML = liveH; 
        
        filterReports(); 
        renderEventCards(); 
        renderRankings(); 
        updateDirectoryPoints(); 
    });

    onValue(ref(db, 'events'), (s) => { 
        const data = s.val(); 
        // Load ALL events into memory (for calculation)
        allEvents = data ? Object.entries(data).map(([key, val]) => ({key, ...val})) : []; 
        
        const filterDropdown = document.getElementById('reportEventFilter');
        const currentSel = filterDropdown.value;
        let opts = `<option value="ALL">All Events</option>`;
        
        // Filter dropdown only shows active events + selected one if it's archived
        allEvents.forEach(e => { 
            if(!e.isDeleted) opts += `<option value="${e.name}">${e.name}</option>`; 
        });
        filterDropdown.innerHTML = opts;
        filterDropdown.value = currentSel;

        let h = ''; 
        allEvents.forEach(e => { 
            // Only render active (not deleted) events in the list
            if (e.isDeleted) return;

            const btns = e.buttons ? e.buttons.map(b=>`<span class="badge bg-light text-dark border ms-1">${b}</span>`).join('') : ''; 
            const pointsTag = e.points > 0 ? `<span class="badge bg-success border ms-2">${e.points} PTS</span>` : '';
            const oneTimeTag = e.isOneTime ? `<span class="badge bg-danger ms-1">1-TIME</span>` : '';
            
            h += `<div class="d-flex justify-content-between align-items-center border-bottom p-2"><div><span class="fw-bold text-primary">${e.name}</span>${pointsTag}${oneTimeTag}<div class="small text-muted mt-1">Buttons:${btns}</div></div><button onclick="removeEvent('${e.key}')" class="btn btn-sm text-danger admin-only"><i class="bi bi-trash"></i></button></div>`; 
        }); 
        document.getElementById('eventsList').innerHTML = h; 
        renderEventCards(); 
        applyPermissions(); 
    });

    function renderRankings() {
        if(allScouts.length === 0) return;
        const sorted = [...allScouts].map(s => ({...s, totalPoints: (calculatedScoutPoints[s.id] || 0)})).sort((a,b) => b.totalPoints - a.totalPoints);
        const top10 = sorted.slice(0, 10);
        let h = '';
        top10.forEach((s, index) => {
            let rank = index + 1;
            let badge = `<span class="rank-badge" style="background:#333; color:white">${rank}</span>`;
            if(rank === 1) badge = `<span class="rank-badge" style="background:var(--gold); color:black">${rank}</span>`;
            if(rank === 2) badge = `<span class="rank-badge" style="background:var(--silver); color:black">${rank}</span>`;
            if(rank === 3) badge = `<span class="rank-badge" style="background:var(--bronze); color:black">${rank}</span>`;
            h += `<tr><td>${badge}</td><td class="fw-bold">${s.name}</td><td class="text-muted small">${s.troop || '-'}</td><td class="fw-bold text-warning">${s.totalPoints}</td></tr>`;
        });
        document.getElementById('rankingsBody').innerHTML = h;
    }

    function updateDirectoryPoints() {
        let h = ''; 
        allScouts.slice().reverse().slice(0,100).forEach(sc => { 
            const safeKey = sc.id.replace(/[.#$/[\]]/g, '_'); 
            const status = sc.isMissing ? '<span class="badge bg-danger">MISSING</span>' : '<span class="badge bg-success">Active</span>'; 
            const pts = calculatedScoutPoints[sc.id] || 0;
            h += `<tr style="cursor:pointer" onclick="viewScout('${safeKey}')"><td>${sc.id}</td><td class="fw-bold text-primary">${sc.name}</td><td>${sc.troop||'-'}</td><td>${pts}</td><td>${status}</td></tr>`; 
        }); 
        document.getElementById('dirTable').innerHTML = h;
    }

    window.filterReports = () => { const filterVal = document.getElementById('reportEventFilter').value; let filteredLogs = allLogs.slice().reverse(); if(filterVal !== 'ALL') filteredLogs = filteredLogs.filter(l => l.eventName === filterVal); document.getElementById('previewCount').innerText = filteredLogs.length; let reportH = ''; filteredLogs.slice(0, 50).forEach(l => { reportH += `<tr><td>${new Date(l.timestamp).toLocaleTimeString()}</td><td>${l.scoutName}</td><td>${l.eventName}</td><td>${l.action}</td></tr>`; }); document.getElementById('reportsPreviewTable').innerHTML = reportH; }
    window.downloadEventReport = () => { const filterVal = document.getElementById('reportEventFilter').value; let filteredLogs = allLogs.slice().reverse(); if(filterVal !== 'ALL') filteredLogs = filteredLogs.filter(l => l.eventName === filterVal); const { jsPDF } = window.jspdf; const doc = new jsPDF(); doc.text(`Report: ${filterVal}`, 14, 10); doc.autoTable({ head: [['Time', 'Scout', 'Event', 'Action', 'Scanned By']], body: filteredLogs.map(l => [new Date(l.timestamp).toLocaleTimeString(), l.scoutName, l.eventName, l.action, l.scannedBy || '-']) }); doc.save(`Report_${filterVal}.pdf`); }
    window.createSpecialQR = async function() { const name = document.getElementById('spName').value; const points = document.getElementById('spPoints').value; const type = document.getElementById('spType').value; if(!name || !points) return; const newRef = push(ref(db, 'special_codes')); await set(newRef, { name: name, points: parseInt(points), type: type, isUsed: false, createdAt: serverTimestamp() }); const { jsPDF } = window.jspdf; const doc = new jsPDF({ format: [80, 80] }); const qrDiv = document.getElementById('qr-hidden'); qrDiv.innerHTML=""; new QRCode(qrDiv, { text: `BONUS:${newRef.key}`, width: 150, height: 150 }); const img = qrDiv.querySelector('canvas').toDataURL("image/png"); doc.setFontSize(12); doc.text("BONUS TOKEN", 40, 10, {align:'center'}); doc.addImage(img, 'PNG', 15, 15, 50, 50); doc.setFontSize(10); doc.text(name, 40, 70, {align:'center'}); doc.text(`${points} PTS (${type === 'onetime' ? '1-Use' : 'Unlim'})`, 40, 75, {align:'center'}); doc.save(`${name}_Bonus.pdf`); };
    onValue(ref(db, 'special_codes'), (s) => { let h = '<ul class="list-group">'; if(s.exists()) { Object.entries(s.val()).forEach(([k, v]) => { h += `<li class="list-group-item d-flex justify-content-between"><div><strong>${v.name}</strong> (${v.points} pts)<br><small class="text-muted">${v.type || 'unlimited'}</small></div><button onclick="removeSpecial('${k}')" class="btn btn-sm btn-outline-danger admin-only"><i class="bi bi-trash"></i></button></li>`; }); } document.getElementById('specialList').innerHTML = h + '</ul>'; applyPermissions(); });
    window.removeSpecial = (k) => remove(ref(db, `special_codes/${k}`));

    window.updatePasteCount = function() { document.getElementById('pasteCount').innerText = document.getElementById('bulkText').value.split('\n').filter(line => line.trim() !== '').length; };
    window.processBulkSafely = async function() { const text = document.getElementById('bulkText').value; if(!text.trim()) return Swal.fire('Error', 'Paste the data first!', 'error'); const lines = text.trim().split('\n').filter(l => l.trim() !== ''); document.getElementById('bulkProgress').style.display = 'flex'; lastBatchScouts = []; let successCount = 0; try { const updates = {}; lines.forEach(line => { const parts = line.split(','); if(parts.length >= 2) { const regNo = parts[0].trim(); const name = parts.slice(1).join(',').trim(); if(regNo && name) { const safeKey = regNo.replace(/[.#$/[\]]/g, '_'); const scoutObj = { id: regNo, name: name, troop: "-", points: 0, isMissing: false, regDate: serverTimestamp() }; updates[`scouts/${safeKey}`] = scoutObj; lastBatchScouts.push(scoutObj); successCount++; } } }); if (Object.keys(updates).length > 0) { await update(ref(db), updates); } document.getElementById('bulkProgress').querySelector('.progress-bar').style.width = '100%'; updateRecentTable(lastBatchScouts); document.getElementById('bulkText').value = ''; Swal.fire({ icon: 'success', title: 'Done', text: `Registered ${successCount} scouts.` }); downloadBatchPDF(lastBatchScouts, `IDs_Export`); } catch(e) { Swal.fire('Error', e.message, 'error'); } finally { setTimeout(() => { document.getElementById('bulkProgress').style.display = 'none'; }, 2000); } };

    window.addStaff = async () => { const e=document.getElementById('stfEmail').value, p=document.getElementById('stfPass').value, r=document.getElementById('stfRole').value; if(e&&p) { try { const c = await createUserWithEmailAndPassword(secondaryAuth, e, p); await set(ref(db, `users/${c.user.uid}`), { email:e, role:r }); Swal.fire('Success', 'Staff Account Created', 'success'); } catch(err) { Swal.fire('Error', err.message, 'error'); } } };
    onValue(ref(db, 'users'), (s) => { const tbody = document.getElementById('staffTable'); tbody.innerHTML = ""; if (s.exists()) { Object.entries(s.val()).forEach(([uid, u]) => { tbody.innerHTML += `<tr><td>${u.email}</td><td><span class="badge bg-dark">${u.role}</span></td><td><button class="btn btn-sm btn-outline-danger admin-only" onclick="removeUser('${uid}')"><i class="bi bi-trash"></i></button></td></tr>`; }); } applyPermissions(); });
    window.removeUser = (uid) => remove(ref(db, `users/${uid}`));
    
    onValue(ref(db, 'scouts'), (s) => { allScouts = s.exists() ? Object.values(s.val()) : []; document.getElementById('statTotal').innerText = allScouts.length; updateDirectoryPoints(); renderRankings(); });

    window.updateButtonPlaceholder = () => { const t = document.getElementById('evtType').value; const b = document.getElementById('evtButtons'); if(t === 'ACCESS') b.value = "IN,OUT"; else if(t === 'ONETIME') b.value = "SCAN"; else b.value = ""; }
    
    window.addEvent = async () => { 
        const n=document.getElementById('evtName').value, p=document.getElementById('evtPoints').value, t=document.getElementById('evtType').value, b=document.getElementById('evtButtons').value, isOneTime=document.getElementById('evtOneTime').checked;
        const bArray = b ? b.split(',').map(s=>s.trim()) : ['SCAN']; if(n) { await push(ref(db, 'events'), {name:n, points:p, type:t, buttons:bArray, active:true, isOneTime:isOneTime, isDeleted: false}); Swal.fire({icon:'success', title:'Event Created', timer:1500, showConfirmButton:false}); document.getElementById('evtName').value = ''; document.getElementById('evtOneTime').checked = false; } 
    }
    
    // --- CHANGED REMOVE TO SOFT DELETE (ARCHIVE) ---
    window.removeEvent = async (k) => {
        // Instead of removing, we set isDeleted to true
        await update(ref(db, `events/${k}`), { isDeleted: true, active: false });
        Swal.fire({icon:'info', title:'Archived', text:'Event hidden, but points preserved.', timer:1500, showConfirmButton:false});
    }

    onValue(ref(db, 'presence'), (snap) => { document.getElementById('statOnline').innerText = snap.exists() ? Object.keys(snap.val()).length : 0; });
    
    function renderEventCards() { const container = document.getElementById('liveEventCards'); container.innerHTML = ""; if (allEvents.length === 0) { container.innerHTML = `<div class="col-12 text-center py-5">No Events created.</div>`; return; } allEvents.forEach(evt => { if(evt.isDeleted) return; let inCount = 0; let outCount = 0; let totalActivityCount = 0; allLogs.forEach(l => { if (l.eventName === evt.name) { if (l.action === 'IN') { inCount++; } else if (l.action === 'OUT') { outCount++; } else { totalActivityCount++; } } }); let body = ''; if (evt.type === 'ACCESS') { body = `<br><div class="row text-center"><div class="col-4 border-end"><h3 class="fw-bold">${inCount}</h3><small class="text-muted">IN</small></div><div class="col-4 border-end"><h3 class="fw-bold">${outCount}</h3><small class="text-muted">OUT</small></div><div class="col-4"><h3 class="fw-bold text-primary">${Math.max(0, inCount - outCount)}</h3><small class="text-primary fw-bold">INSIDE</small></div></div>`; } else { body = `<br><div class="text-center py-2"><h2 class="text-success display-4 fw-bold">${totalActivityCount}</h2><small class="text-muted fw-bold text-uppercase">Total Completed</small></div>`; } const tag = evt.isOneTime ? '<span class="badge bg-danger border ms-2">1-TIME</span>' : ''; container.innerHTML += `<br><div class="col-md-4"><div class="stat-card border-top border-4 border-primary h-100"><div class="d-flex justify-content-between align-items-start mb-2"><h5 class="fw-bold mb-0 text-truncate" style="max-width:80%">${evt.name}</h5><div>${tag}<span class="badge bg-light text-dark border">${evt.type}</span></div></div><hr class="my-3" style="opacity:0.1">${body}</div></div>`; }); }
    function updateRecentTable(list) { let h=''; list.slice().reverse().forEach(s=>{ h+=`<tr><td>${s.id}</td><td>${s.name}</td></tr>`}); document.getElementById('regTable').innerHTML=h; }
    
    window.downloadBatchPDF = function(scoutList, filename) { if(!scoutList || scoutList.length === 0) return; const { jsPDF } = window.jspdf; const doc = new jsPDF(); const cardW = 45, cardH = 65, marginX = 15, marginY = 15, gap = 2; let col = 0, row = 0; const qrDiv = document.getElementById('qr-hidden'); scoutList.forEach((s, i) => { if(i > 0 && i % 16 === 0) { doc.addPage(); col = 0; row = 0; } qrDiv.innerHTML = ""; new QRCode(qrDiv, { text: s.id, width: 200, height: 200, correctLevel: QRCode.CorrectLevel.H }); const img = qrDiv.querySelector('canvas').toDataURL("image/png"); const curX = marginX + (col * (cardW + gap)); const curY = marginY + (row * (cardH + gap)); const centerX = curX + (cardW/2); doc.setLineWidth(0.1); doc.rect(curX, curY, cardW, cardH); doc.setFont("helvetica", "bold"); doc.setFontSize(9); doc.text("SCOUT PASS", centerX, curY + 6, {align:'center'}); doc.addImage(img, 'PNG', curX + (cardW - 35)/2, curY + 9, 35, 35); doc.setFont("helvetica", "bold"); doc.setFontSize(11); doc.text(s.id, centerX, curY + 50, {align:'center'}); doc.setFont("helvetica", "normal"); doc.setFontSize(9); let printName = s.name.length > 20 ? s.name.substring(0,18) + '..' : s.name; doc.text(printName, centerX, curY + 56, {align:'center'}); doc.setFontSize(6); doc.setTextColor(150); doc.text("SCAN TO VERIFY", centerX, curY + 62, {align:'center'}); doc.setTextColor(0); col++; if(col >= 4) { col = 0; row++; } }); doc.save(filename ? `${filename}.pdf` : `Scout_IDs.pdf`); }
    window.exportData = function() { if(allScouts.length === 0) return Swal.fire('Empty', 'No data to export', 'info'); const dataStr = JSON.stringify(allScouts, null, 2); const blob = new Blob([dataStr], {type: "application/json"}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `ScoutDB_Backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); }
    window.importData = function(input) { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = async function(e) { try { const data = JSON.parse(e.target.result); if(!Array.isArray(data)) throw new Error("Invalid Format"); const updates = {}; data.forEach(s => { const safeKey = s.id.replace(/[.#$/[\]]/g, '_'); updates[`scouts/${safeKey}`] = s; }); await update(ref(db), updates); Swal.fire('Success', `Restored ${data.length} records.`, 'success'); } catch(err) { Swal.fire('Error', 'Invalid File Format', 'error'); } input.value = ''; }; reader.readAsText(file); }
    window.showSection = (id) => { document.querySelectorAll('.section').forEach(d=>d.style.display='none'); document.getElementById('sec-'+id).style.display='block'; document.getElementById('pageTitle').innerText = id.toUpperCase(); };
    window.logout = () => signOut(auth).then(()=>window.location.href="index.html"); window.filterDirectory = () => { const term = document.getElementById('searchDir').value.toLowerCase(); document.querySelectorAll('#dirTable tr').forEach(row => { row.style.display = row.innerText.toLowerCase().includes(term) ? '' : 'none'; }); };
    
    window.initiateSystemReset = async () => { const { value: code } = await Swal.fire({ title: '⚠️ SYSTEM RESET', input: 'password', inputLabel: 'Enter Admin Password', inputPlaceholder: 'Password', confirmButtonText: 'Verify', confirmButtonColor: '#d33', showCancelButton: true }); if (code === 'MadhawaBasnayake@20041110') { const result = await Swal.fire({ title: 'Are you sure?', text: "This will delete ALL Scouts, Logs, and Events. Staff accounts will remain.", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#3085d6', confirmButtonText: 'Yes, WIPE EVERYTHING!' }); if (result.isConfirmed) { try { await remove(ref(db, 'scouts')); await remove(ref(db, 'logs')); await remove(ref(db, 'events')); await remove(ref(db, 'alerts')); await remove(ref(db, 'special_codes')); await set(ref(db, 'system/scoutCounter'), 0); Swal.fire('WIPED!', 'System has been reset successfully.', 'success'); } catch (error) { Swal.fire('Error', error.message, 'error'); } } } else if (code) { Swal.fire('Error', 'Invalid Admin Password!', 'error'); } };

    window.viewScout = (safeKey) => { const sc = allScouts.find(s => s.id.replace(/[.#$/[\]]/g, '_') === safeKey); if(sc) { document.getElementById('panelName').innerText = sc.name; document.getElementById('panelID').innerText = sc.id; document.getElementById('panelPoints').innerText = calculatedScoutPoints[sc.id] || 0; document.getElementById('panelTroop').innerText = sc.troop || '-'; selectedScoutData = sc; const btn = document.getElementById('btnToggleMissing'); if(sc.isMissing) { btn.className = "btn btn-success"; btn.innerText = "Mark as Safe"; } else { btn.className = "btn btn-outline-danger"; btn.innerText = "Mark as Missing"; } new bootstrap.Offcanvas(document.getElementById('scoutOffcanvas')).show(); applyPermissions(); } };
    window.toggleMissingFromPanel = async () => { if(!selectedScoutData) return; const safeKey = selectedScoutData.id.replace(/[.#$/[\]]/g, '_'); const newState = !selectedScoutData.isMissing; await update(ref(db, `scouts/${safeKey}`), { isMissing: newState }); if(newState) { push(ref(db, 'alerts'), { scoutName: selectedScoutData.name, location: "Admin Panel Report", timestamp: serverTimestamp() }); Swal.fire({icon: 'warning', title: 'Marked Missing', text: 'Alert Sent!'}); } else { Swal.fire({icon: 'success', title: 'Marked Safe'}); } viewScout(safeKey); };
    window.downloadSingleID = () => downloadBatchPDF([selectedScoutData], `${selectedScoutData.id.replace(/[.#$/[\]]/g, '_')}`); window.deleteScoutFromPanel = async () => { if(!selectedScoutData) return; await remove(ref(db, `scouts/${selectedScoutData.id.replace(/[.#$/[\]]/g, '_')}`)); bootstrap.Offcanvas.getInstance(document.getElementById('scoutOffcanvas')).hide(); }; window.exportLogsPDF = () => { const { jsPDF } = window.jspdf; const doc = new jsPDF(); doc.autoTable({ head: [['Time', 'Scout', 'Event', 'Action']], body: allLogs.map(l => [new Date(l.timestamp).toLocaleTimeString(), l.scoutName, l.eventName, l.action]) }); doc.save(`Logs.pdf`); }
</script>
</body>
</html>
