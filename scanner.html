<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ScoutPass Pro Scanner</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root { --bg-dark: #121212; --surface: #1e1e1e; --primary: #6c5ce7; --text: #ecf0f1; }
        body { background-color: var(--bg-dark); color: var(--text); font-family: 'Inter', sans-serif; overflow-x: hidden; }

        /* OFFLINE BANNER */
        #offlineBanner {
            position: fixed; top: 0; left: 0; width: 100%; background: #c0392b; color: white;
            text-align: center; padding: 8px; font-weight: bold; font-size: 0.9rem; display: none; z-index: 10000;
        }

        /* LOCKED SCREEN */
        #lockedScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(214, 48, 49, 0.95); backdrop-filter: blur(5px);
            z-index: 9999; display: none; flex-direction: column; 
            align-items: center; justify-content: center; text-align: center;
        }

        /* SETUP SCREEN */
        .setup-container { max-width: 400px; margin: 10vh auto; padding: 20px; }
        .card-dark { background: var(--surface); border-radius: 16px; padding: 25px; border: 1px solid #333; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        
        /* SCANNER UI */
        #scannerUI { display: none; height: 100vh; flex-direction: column; }
        .scanner-header { padding: 15px; background: var(--surface); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        .camera-viewport { flex-grow: 1; position: relative; background: #000; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        #reader { width: 100%; height: 100%; object-fit: cover; }
        
        /* CONTROLS OVERLAY */
        .controls-overlay {
            position: absolute; bottom: 20px; left: 0; width: 100%;
            display: flex; justify-content: center; gap: 15px; z-index: 10;
        }
        .ctrl-btn {
            background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);
            color: white; width: 50px; height: 50px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
            backdrop-filter: blur(4px); transition: 0.2s;
        }
        .ctrl-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.4); }
        .ctrl-btn.active { background: #f1c40f; color: black; border-color: #f1c40f; }

        /* ACTION SHEET */
        .action-sheet {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--surface); border-top-left-radius: 20px; border-top-right-radius: 20px;
            padding: 25px; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            z-index: 5000; border-top: 1px solid #444;
        }
        .action-sheet.show { transform: translateY(0); }
        
        .scout-details { text-align: center; margin-bottom: 20px; }
        .scout-name { font-size: 1.4rem; font-weight: 700; color: white; }
        .scout-meta { color: #aaa; font-size: 0.9rem; }
        .missing-alert { background: #ff4757; color: white; padding: 10px; border-radius: 8px; font-weight: bold; margin-bottom: 15px; animation: flash 1s infinite; display: none; }
        
        @keyframes flash { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

        .btn-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .btn-scan-action {
            padding: 16px; border-radius: 12px; border: none; font-weight: 700;
            font-size: 1.1rem; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .btn-in { background: #2ecc71; color: white; }
        .btn-out { background: #e74c3c; color: white; }
        .btn-neutral { background: #3498db; color: white; }
        
    </style>
</head>
<body>

    <div id="offlineBanner"><i class="bi bi-wifi-off"></i> You are Offline. Some data may not save.</div>

    <div id="lockedScreen">
        <i class="bi bi-lock-fill" style="font-size: 60px; color: white;"></i>
        <h2 class="mt-3 text-white fw-bold">SCANNING LOCKED</h2>
        <p class="text-white-50">Admin has paused the system.</p>
    </div>

    <div id="setupScreen" class="setup-container">
        <div class="text-center mb-4">
            <h2 class="fw-bold text-primary"><i class="bi bi-qr-code-scan"></i> ScoutPass</h2>
            <p class="text-muted small">Staff Access Terminal</p>
        </div>

        <div id="loginForm" class="card-dark">
            <h5 class="mb-3">Staff Login</h5>
            <input type="email" id="email" class="form-control mb-3 bg-dark text-white border-secondary" placeholder="Email">
            <input type="password" id="pass" class="form-control mb-3 bg-dark text-white border-secondary" placeholder="Password">
            <button onclick="login()" class="btn btn-primary w-100 fw-bold">Unlock Scanner</button>
        </div>

        <div id="eventForm" class="card-dark" style="display:none;">
            <h5 class="mb-3">Select Event</h5>
            <p class="text-muted small mb-2">Choose the active event to start:</p>
            <select id="eventSelect" class="form-select bg-dark text-white border-secondary mb-3"></select>
            
            <label class="small text-muted mb-2">Camera Source</label>
            <select id="cameraSelect" class="form-select bg-dark text-white border-secondary mb-4"></select>
            
            <button onclick="launchScanner()" class="btn btn-success w-100 fw-bold py-2">START SCANNING</button>
            <button onclick="logout()" class="btn btn-link text-danger w-100 mt-2 text-decoration-none">Logout</button>
        </div>
    </div>

    <div id="scannerUI">
        <div class="scanner-header">
            <div>
                <div class="fw-bold" id="activeEventName">Event Name</div>
                <div class="small text-muted" id="staffName">Staff</div>
            </div>
            <button onclick="stopScanner()" class="btn btn-sm btn-outline-secondary">Exit</button>
        </div>

        <div class="camera-viewport">
            <div id="reader"></div>
            
            <div class="controls-overlay">
                <button class="ctrl-btn" onclick="toggleFlash()" id="flashBtn"><i class="bi bi-lightning-fill"></i></button>
                <button class="ctrl-btn" onclick="switchCamera()"><i class="bi bi-arrow-repeat"></i></button>
            </div>
        </div>
    </div>

    <div class="action-sheet" id="actionSheet">
        <div class="scout-details">
            <div id="missingAlert" class="missing-alert">⚠️ MISSING SCOUT DETECTED!</div>
            <div class="scout-name" id="sheetName">Scanning...</div>
            <div class="scout-meta" id="sheetID">---</div>
            <div class="scout-meta mt-1 text-info" id="sheetTroop">---</div>
        </div>
        
        <div id="actionButtons" class="btn-grid">
            </div>
        <button onclick="closeSheet()" class="btn btn-outline-light w-100 mt-3 border-0">Cancel</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, onValue, push, serverTimestamp, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCIrXtwckl-4RPOXDn5IOMiHFh_uXdPiKQ",
            authDomain: "scoutpass-276cb.firebaseapp.com",
            projectId: "scoutpass-276cb",
            databaseURL: "https://scoutpass-276cb-default-rtdb.asia-southeast1.firebasedatabase.app/"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // STATE
        let html5QrCode;
        let selectedEvent = null;
        let currentCameraId = null;
        let cameras = [];
        let isFlashOn = false;

        // --- OFFLINE DETECTION ---
        window.addEventListener('online', () => document.getElementById('offlineBanner').style.display = 'none');
        window.addEventListener('offline', () => document.getElementById('offlineBanner').style.display = 'block');

        // --- AUTH FLOW ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('eventForm').style.display = 'block';
                document.getElementById('staffName').innerText = user.email.split('@')[0];
                loadEvents();
                initCameras();
            } else {
                document.getElementById('loginForm').style.display = 'block';
                document.getElementById('eventForm').style.display = 'none';
            }
        });

        window.login = () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('pass').value;
            signInWithEmailAndPassword(auth, e, p).catch(err => Swal.fire('Error', err.message, 'error'));
        };

        window.logout = () => signOut(auth).then(() => location.reload());

        // --- SYSTEM LOCK ---
        onValue(ref(db, 'system_settings/scanning_active'), (snap) => {
            const unlocked = snap.val();
            document.getElementById('lockedScreen').style.display = unlocked ? 'none' : 'flex';
            if(!unlocked && html5QrCode) stopScanner();
        });

        // --- LOAD EVENTS & CAMERAS ---
        function loadEvents() {
            onValue(ref(db, 'events'), (snap) => {
                const sel = document.getElementById('eventSelect');
                sel.innerHTML = "";
                if(snap.exists()) {
                    Object.entries(snap.val()).forEach(([k, v]) => {
                        if(v.active) {
                            const opt = document.createElement('option');
                            opt.value = k;
                            opt.text = v.name;
                            opt.dataset.buttons = v.buttons ? v.buttons.join(',') : 'SCAN';
                            sel.appendChild(opt);
                        }
                    });
                }
            });
        }

        async function initCameras() {
            try {
                cameras = await Html5Qrcode.getCameras();
                const camSel = document.getElementById('cameraSelect');
                camSel.innerHTML = "";
                if (cameras && cameras.length) {
                    cameras.forEach(cam => {
                        const opt = document.createElement('option');
                        opt.value = cam.id;
                        opt.text = cam.label || `Camera ${camSel.options.length + 1}`;
                        camSel.appendChild(opt);
                    });
                    // Try to select back camera by default
                    const backCam = cameras.find(c => c.label.toLowerCase().includes('back') || c.label.toLowerCase().includes('environment'));
                    currentCameraId = backCam ? backCam.id : cameras[0].id;
                    camSel.value = currentCameraId;
                }
            } catch (e) { console.error("Camera Error", e); }
        }

        // --- SCANNER LOGIC ---
        window.launchScanner = () => {
            const evtSel = document.getElementById('eventSelect');
            selectedEvent = {
                id: evtSel.value,
                name: evtSel.options[evtSel.selectedIndex].text,
                buttons: evtSel.options[evtSel.selectedIndex].dataset.buttons.split(',')
            };

            currentCameraId = document.getElementById('cameraSelect').value;
            document.getElementById('activeEventName').innerText = selectedEvent.name;
            document.getElementById('setupScreen').style.display = 'none';
            document.getElementById('scannerUI').style.display = 'flex';
            
            startQrCode();
        };

        function startQrCode() {
            html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 };
            
            html5QrCode.start(
                currentCameraId, 
                config,
                (decodedText) => handleScan(decodedText),
                (err) => {}
            ).catch(err => {
                Swal.fire("Camera Error", "Please allow camera permissions.", "error");
                stopScanner();
            });
        }

        // --- HANDLE SCAN RESULTS ---
        async function handleScan(code) {
            if(document.getElementById('actionSheet').classList.contains('show')) return; // Ignore if sheet open
            
            // 1. SPECIAL QR CHECK
            if (code.startsWith("BONUS:")) {
                html5QrCode.pause();
                const codeKey = code.split(':')[1];
                const codeRef = ref(db, `special_codes/${codeKey}`);
                const snap = await get(codeRef);
                
                if (snap.exists()) {
                    const data = snap.val();
                    Swal.fire({
                        icon: 'info',
                        title: 'Bonus Token',
                        text: `${data.name} - ${data.points} Points`,
                        confirmButtonText: 'OK'
                    }).then(() => html5QrCode.resume());
                } else {
                    Swal.fire('Invalid', 'This token is invalid.', 'error').then(() => html5QrCode.resume());
                }
                return;
            }

            // 2. SCOUT ID CHECK
            html5QrCode.pause();
            const safeKey = code.replace('/', '_'); // Standardize ID key
            const scoutRef = ref(db, `scouts/${safeKey}`);
            
            try {
                const snap = await get(scoutRef);
                if (snap.exists()) {
                    const scout = snap.val();
                    showActionSheet(scout, code);
                } else {
                    Swal.fire({ icon: 'error', title: 'Not Found', text: 'ID not found in database.', timer: 1500, showConfirmButton: false }).then(() => html5QrCode.resume());
                }
            } catch(e) {
                console.error(e);
                html5QrCode.resume();
            }
        }

        function showActionSheet(scout, rawID) {
            // Populate Data
            document.getElementById('sheetName').innerText = scout.name;
            document.getElementById('sheetID').innerText = scout.id;
            document.getElementById('sheetTroop').innerText = scout.troop || '';
            
            // Missing Alert Logic
            const alertBox = document.getElementById('missingAlert');
            if(scout.isMissing) {
                alertBox.style.display = 'block';
                // Play sound or vibrate
                if(navigator.vibrate) navigator.vibrate([200, 100, 200]);
            } else {
                alertBox.style.display = 'none';
            }

            // Render Buttons dynamically based on Event
            const btnContainer = document.getElementById('actionButtons');
            btnContainer.innerHTML = "";
            
            selectedEvent.buttons.forEach(btnLabel => {
                const btn = document.createElement('button');
                btn.innerText = btnLabel;
                btn.className = "btn-scan-action";
                
                // Color coding
                if(btnLabel === 'IN') btn.classList.add('btn-in');
                else if(btnLabel === 'OUT') btn.classList.add('btn-out');
                else btn.classList.add('btn-neutral'); // Breakfast / Collected etc.

                btn.onclick = () => submitAction(scout, rawID, btnLabel);
                btnContainer.appendChild(btn);
            });

            // Show Sheet
            document.getElementById('actionSheet').classList.add('show');
        }

        window.submitAction = async (scout, rawID, action) => {
            // Save Log
            const logEntry = {
                scoutID: rawID,
                scoutName: scout.name,
                eventName: selectedEvent.name,
                eventID: selectedEvent.id,
                action: action,
                timestamp: serverTimestamp(),
                scannedBy: auth.currentUser.email,
                type: 'ACCESS' // or update based on event type if needed
            };
            
            await push(ref(db, 'logs'), logEntry);
            
            // Success Feedback
            const Toast = Swal.mixin({ toast: true, position: 'top', showConfirmButton: false, timer: 1500 });
            Toast.fire({ icon: 'success', title: `${action} Recorded` });
            
            closeSheet();
        };

        window.closeSheet = () => {
            document.getElementById('actionSheet').classList.remove('show');
            setTimeout(() => html5QrCode.resume(), 300); // Resume scanning
        };

        window.stopScanner = () => {
            if(html5QrCode) {
                html5QrCode.stop().then(() => {
                    document.getElementById('scannerUI').style.display = 'none';
                    document.getElementById('setupScreen').style.display = 'block';
                });
            }
        };

        // --- CAMERA CONTROLS ---
        window.toggleFlash = () => {
            if(!html5QrCode) return;
            isFlashOn = !isFlashOn;
            html5QrCode.applyVideoConstraints({
                advanced: [{ torch: isFlashOn }]
            }).catch(e => {
                isFlashOn = !isFlashOn;
                Swal.fire({toast: true, position: 'top', title: 'Flash unavailable', icon: 'warning'});
            });
            
            const btn = document.getElementById('flashBtn');
            if(isFlashOn) btn.classList.add('active'); else btn.classList.remove('active');
        };

        window.switchCamera = () => {
            // Cycle through cameras
            if (cameras.length > 1) {
                const currentIndex = cameras.findIndex(c => c.id === currentCameraId);
                const nextIndex = (currentIndex + 1) % cameras.length;
                currentCameraId = cameras[nextIndex].id;
                
                html5QrCode.stop().then(() => {
                    startQrCode();
                });
            } else {
                Swal.fire({toast: true, position: 'top', title: 'Only one camera found'});
            }
        };

    </script>
</body>
</html>
