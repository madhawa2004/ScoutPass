<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ScoutPass Scanner V26</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f2f2f2; color: #333; height: 100vh; overflow: hidden; }

        /* 1. LOGIN SCREEN */
        #loginScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 2000; display: flex; flex-direction: column;
            align-items: center; justify-content: center; padding: 30px;
        }

        /* 2. MAIN SCANNER SCREEN (Based on your UI) */
        #mainScreen { display: none; height: 100%; flex-direction: column; padding: 20px; max-width: 500px; margin: auto; }
        
        .header-title { text-align: center; color: #1877F2; font-weight: 700; font-size: 1.2rem; margin-bottom: 20px; letter-spacing: 1px; }

        .camera-container {
            width: 100%; aspect-ratio: 1/1; background: #2c3e50; border-radius: 20px;
            overflow: hidden; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 20px; border: 4px solid white;
        }
        #reader { width: 100%; height: 100%; object-fit: cover; }
        
        .form-group label { font-size: 0.8rem; font-weight: 600; color: #777; margin-bottom: 5px; margin-left: 5px; }
        .custom-input {
            border: none; background: white; padding: 15px; border-radius: 12px;
            width: 100%; box-shadow: 0 4px 15px rgba(0,0,0,0.05); font-weight: 600; margin-bottom: 15px;
        }
        
        .btn-scan-trigger {
            background: #1877F2; color: white; border: none; padding: 18px;
            width: 100%; border-radius: 30px; font-weight: 700; font-size: 1.1rem;
            box-shadow: 0 5px 20px rgba(24, 119, 242, 0.3); margin-top: auto;
        }
        .btn-scan-trigger:active { transform: scale(0.98); }

        /* 3. SCOUT DETAILS MODAL (Variant 1 Style) */
        #resultModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 3000; display: none;
            align-items: center; justify-content: center; padding: 20px;
        }
        .result-card {
            background: white; width: 100%; max-width: 380px; border-radius: 25px;
            padding: 30px 20px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .avatar-circle {
            width: 90px; height: 90px; background: #ffeaa7; color: #d35400;
            border-radius: 50%; margin: 0 auto 15px; font-size: 40px;
            display: flex; align-items: center; justify-content: center; border: 4px solid white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .scout-name { font-size: 1.4rem; font-weight: 700; color: #333; margin-bottom: 2px; }
        .scout-info { font-size: 0.9rem; color: #888; margin-bottom: 25px; }
        
        .action-btn {
            width: 100%; padding: 14px; border-radius: 50px; font-weight: 600; margin-bottom: 10px;
            border: none; font-size: 1rem; transition: 0.2s;
        }
        .btn-primary-action { background: #1877F2; color: white; box-shadow: 0 4px 15px rgba(24, 119, 242, 0.2); }
        .btn-secondary-action { background: white; color: #333; border: 1px solid #ddd; }
        .btn-cancel { color: #aaa; background: none; margin-top: 10px; font-size: 0.9rem; }

        /* 4. MISSING ALERT (Red Screen) */
        #missingAlert {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #FF3B30; color: white; z-index: 4000; display: none;
            flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 30px;
        }
        .alert-avatar {
            width: 120px; height: 120px; border-radius: 50%; border: 5px solid rgba(255,255,255,0.3);
            margin: 30px 0; background: white; color: #FF3B30; display: flex; align-items: center; justify-content: center; font-size: 50px;
        }
        .btn-dismiss {
            background: white; color: #FF3B30; padding: 15px 40px; border-radius: 50px;
            font-weight: 700; border: none; margin-top: 40px; width: 100%; max-width: 300px;
        }

        /* 5. OFFLINE & LOCKED */
        .system-locked {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 59, 48, 0.95); z-index: 5000; display: none;
            align-items: center; justify-content: center; color: white; flex-direction: column;
        }
    </style>
</head>
<body>

    <div id="lockedOverlay" class="system-locked">
        <i class="bi bi-lock-fill" style="font-size: 3rem;"></i>
        <h3 class="mt-3 fw-bold">SYSTEM LOCKED</h3>
        <p>Admin has paused scanning</p>
    </div>

    <div id="loginScreen">
        <h2 class="fw-bold text-primary mb-1">SCOUTPASS</h2>
        <p class="text-muted mb-4">Staff Login</p>
        <input type="email" id="stfEmail" class="custom-input bg-light border" placeholder="Staff Email">
        <input type="password" id="stfPass" class="custom-input bg-light border" placeholder="Password">
        <button onclick="staffLogin()" class="btn-scan-trigger">LOGIN</button>
    </div>

    <div id="mainScreen">
        <div class="header-title">SCOUTPASS SCANNER</div>

        <div class="camera-container">
            <div id="reader"></div>
            <div id="cameraPlaceholder" class="d-flex align-items-center justify-content-center h-100 text-white-50">
                <span>Camera Inactive</span>
            </div>
        </div>

        <div class="form-group">
            <label>EVENT</label>
            <select id="eventSelect" class="custom-input form-select" onchange="enableScanning()">
                <option value="" disabled selected>Select Event</option>
            </select>
        </div>

        <div class="form-group">
            <label>MANUAL ID</label>
            <input type="text" id="manualInput" class="custom-input" placeholder="Enter ID Manually">
        </div>

        <button onclick="handleManualSubmit()" class="btn-scan-trigger" id="scanBtn">
            <i class="bi bi-qr-code-scan me-2"></i> SCAN / SUBMIT
        </button>
        
        <div class="text-center mt-3">
            <small class="text-muted" onclick="switchCamera()">Switch Camera</small> | 
            <small class="text-danger fw-bold" onclick="staffLogout()">Logout</small>
        </div>
    </div>

    <div id="resultModal">
        <div class="result-card">
            <div class="d-flex align-items-center mb-3 text-secondary" onclick="closeModal()">
                <i class="bi bi-arrow-left fs-4"></i> <span class="ms-2 fw-bold">Scout Details</span>
            </div>
            
            <div class="avatar-circle"><i class="bi bi-person-fill"></i></div>
            
            <h3 class="scout-name" id="resName">Alex Johnson</h3>
            <p class="scout-info">ID: <span id="resID">123456</span><br><span id="resTroop">Troop 73</span></p>
            
            <div class="text-start fw-bold mb-2 text-secondary" style="font-size:0.8rem;">Event Actions</div>
            <div id="dynamicButtons">
                </div>
            
            <button onclick="closeModal()" class="btn-cancel border-0">Cancel</button>
        </div>
    </div>

    <div id="missingAlert">
        <div class="fw-bold fs-5 opacity-75">ðŸš¨ ALERT</div>
        <h1 class="fw-bold mt-2">MISSING SCOUT<br>FOUND!</h1>
        
        <div class="alert-avatar"><i class="bi bi-exclamation-triangle-fill"></i></div>
        
        <h2 class="fw-bold" id="misName">Alexandre Dumas</h2>
        <p class="opacity-75" id="misTroop">Cimarron Council / Troop 451</p>
        
        <button onclick="closeMissingAlert()" class="btn-dismiss">Dismiss</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, onValue, push, serverTimestamp, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCIrXtwckl-4RPOXDn5IOMiHFh_uXdPiKQ",
            authDomain: "scoutpass-276cb.firebaseapp.com",
            projectId: "scoutpass-276cb",
            databaseURL: "https://scoutpass-276cb-default-rtdb.asia-southeast1.firebasedatabase.app/"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let html5QrCode;
        let selectedEvent = null;
        let currentScout = null;
        let cameras = [];
        let camId = 0;

        // --- AUTH & SETUP ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainScreen').style.display = 'flex';
                loadEvents();
                startCamera();
            } else {
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('mainScreen').style.display = 'none';
            }
        });

        window.staffLogin = () => {
            const e = document.getElementById('stfEmail').value;
            const p = document.getElementById('stfPass').value;
            signInWithEmailAndPassword(auth, e, p).catch(err => Swal.fire('Error', err.message, 'error'));
        }
        window.staffLogout = () => signOut(auth);

        // --- SYSTEM LOCK ---
        onValue(ref(db, 'system_settings/scanning_active'), (s) => {
            const active = s.val();
            document.getElementById('lockedOverlay').style.display = active ? 'none' : 'flex';
            if(!active && html5QrCode) html5QrCode.pause();
            if(active && html5QrCode) html5QrCode.resume();
        });

        // --- EVENTS ---
        function loadEvents() {
            onValue(ref(db, 'events'), (s) => {
                const sel = document.getElementById('eventSelect');
                sel.innerHTML = '<option value="" disabled selected>Select Event</option>';
                if(s.exists()) {
                    Object.entries(s.val()).forEach(([k, v]) => {
                        if(v.active) {
                            const opt = document.createElement('option');
                            opt.value = k;
                            opt.text = v.name;
                            opt.dataset.buttons = v.buttons ? v.buttons.join(',') : 'SCAN';
                            sel.appendChild(opt);
                        }
                    });
                }
            });
        }

        window.enableScanning = () => {
            const sel = document.getElementById('eventSelect');
            const idx = sel.selectedIndex;
            if (idx > 0) {
                selectedEvent = {
                    id: sel.value,
                    name: sel.options[idx].text,
                    buttons: sel.options[idx].dataset.buttons.split(',')
                };
            }
        }

        // --- CAMERA ---
        function startCamera() {
            Html5Qrcode.getCameras().then(dev => {
                if (dev && dev.length) {
                    cameras = dev;
                    // Prefer back camera
                    const backCam = cameras.find(c => c.label.toLowerCase().includes('back'));
                    const startCamId = backCam ? backCam.id : cameras[0].id;
                    
                    html5QrCode = new Html5Qrcode("reader");
                    html5QrCode.start(
                        startCamId, 
                        { fps: 10, qrbox: { width: 250, height: 250 } },
                        (txt) => processScan(txt),
                        (err) => {}
                    );
                    document.getElementById('cameraPlaceholder').style.display = 'none';
                }
            }).catch(err => console.error(err));
        }

        window.switchCamera = () => {
            if(cameras.length < 2) return Swal.fire('Info', 'Only one camera detected', 'info');
            camId = (camId + 1) % cameras.length;
            html5QrCode.stop().then(() => {
                html5QrCode.start(cameras[camId].id, { fps: 10, qrbox: { width: 250, height: 250 } }, (txt) => processScan(txt), () => {});
            });
        }

        // --- SCAN PROCESSING ---
        window.handleManualSubmit = () => {
            const val = document.getElementById('manualInput').value;
            if(val) processScan(val);
        }

        async function processScan(code) {
            // Check if Event Selected
            if (!selectedEvent) {
                if(html5QrCode) html5QrCode.pause();
                await Swal.fire({ icon: 'warning', title: 'Select Event First', text: 'Please select an event from the dropdown.' });
                if(html5QrCode) html5QrCode.resume();
                return;
            }

            if(html5QrCode) html5QrCode.pause();

            // Check Bonus
            if (code.startsWith("BONUS:")) {
                // ... (Same Bonus Logic as before if needed)
                Swal.fire('Bonus', 'Bonus tokens not implemented in this UI yet', 'info').then(() => html5QrCode.resume());
                return;
            }

            // Fetch Scout
            const safeKey = code.replace('/', '_');
            const snap = await get(ref(db, `scouts/${safeKey}`));

            if (snap.exists()) {
                currentScout = snap.val();
                
                // MISSING CHECK
                if (currentScout.isMissing) {
                    showMissingAlert(currentScout);
                } else {
                    showResultModal(currentScout, code);
                }
            } else {
                Swal.fire({ icon: 'error', title: 'Invalid ID', timer: 1500, showConfirmButton:false }).then(() => html5QrCode.resume());
            }
            
            document.getElementById('manualInput').value = "";
        }

        // --- SHOW UI ---
        function showResultModal(scout, rawID) {
            document.getElementById('resName').innerText = scout.name;
            document.getElementById('resID').innerText = scout.id;
            document.getElementById('resTroop').innerText = scout.troop;
            
            const btnContainer = document.getElementById('dynamicButtons');
            btnContainer.innerHTML = "";
            
            selectedEvent.buttons.forEach((btnLabel, index) => {
                const btn = document.createElement('button');
                btn.innerText = btnLabel;
                btn.className = index === 0 ? "action-btn btn-primary-action" : "action-btn btn-secondary-action";
                btn.onclick = () => submitAction(rawID, scout.name, btnLabel);
                btnContainer.appendChild(btn);
            });

            document.getElementById('resultModal').style.display = 'flex';
        }

        function showMissingAlert(scout) {
            document.getElementById('misName').innerText = scout.name;
            document.getElementById('misTroop').innerText = scout.troop;
            document.getElementById('missingAlert').style.display = 'flex';
            // Vibrate
            if(navigator.vibrate) navigator.vibrate([500, 200, 500]);
        }

        // --- ACTIONS ---
        window.submitAction = async (rawID, name, action) => {
            const logEntry = {
                scoutID: rawID,
                scoutName: name,
                eventName: selectedEvent.name,
                eventID: selectedEvent.id,
                action: action,
                timestamp: serverTimestamp(),
                scannedBy: auth.currentUser.email
            };

            try {
                await push(ref(db, 'logs'), logEntry);
                closeModal();
                
                const Toast = Swal.mixin({ toast: true, position: 'bottom', showConfirmButton: false, timer: 2000 });
                Toast.fire({ icon: 'success', title: `${action} Successful` });

            } catch (e) {
                Swal.fire('Error', e.message, 'error');
            }
        }

        window.closeModal = () => {
            document.getElementById('resultModal').style.display = 'none';
            if(html5QrCode) html5QrCode.resume();
        }

        window.closeMissingAlert = () => {
            document.getElementById('missingAlert').style.display = 'none';
            if(html5QrCode) html5QrCode.resume();
        }

    </script>
</body>
</html>
